# 1 å¼•è¨€

## 1.1 ç¼–å†™ç›®çš„

ç›®çš„æ˜¯å¸®åŠ©ç ”å‘ã€æµ‹è¯•æŒæ¡å’Œäº†è§£è®¾è®¡æ—¥å¿—ä¸­å¿ƒçš„å¼€å‘ç›®çš„ä»¥åŠå¼€å‘æ–¹å¼ã€‚

## 1.2 èƒŒæ™¯

ä»€ä¹ˆæ˜¯æ—¥å¿—ï¼Ÿ æ—¥å¿—å°±æ˜¯ç¨‹åºäº§ç”Ÿçš„ï¼Œéµå¾ªä¸€å®šæ ¼å¼ï¼ˆé€šå¸¸åŒ…å«æ—¶é—´æˆ³ï¼‰çš„æ–‡æœ¬æ•°æ®ã€‚é€šå¸¸æ—¥å¿—ç”±æœåŠ¡å™¨ç”Ÿæˆï¼Œè¾“å‡ºåˆ°ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œä¸€èˆ¬ä¼šæœ‰ç³»ç»Ÿæ—¥å¿—ã€ åº”ç”¨æ—¥å¿—ã€å®‰å…¨æ—¥å¿—ã€‚è¿™äº›æ—¥å¿—åˆ†æ•£åœ°å­˜å‚¨åœ¨ä¸åŒçš„æœºå™¨ä¸Šã€‚é€šå¸¸å½“ç³»ç»Ÿå‘ç”Ÿæ•…éšœæ—¶ï¼Œå·¥ç¨‹å¸ˆéœ€è¦ç™»å½•åˆ°å„ä¸ªæœåŠ¡å™¨ä¸Šï¼Œä½¿ç”¨ grep / sed / awk ç­‰ Linux è„šæœ¬å·¥å…·å»æ—¥å¿—é‡ŒæŸ¥æ‰¾æ•…éšœåŸå› ã€‚åœ¨æ²¡æœ‰æ—¥å¿—ç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œé¦–å…ˆéœ€è¦å®šä½å¤„ç†è¯·æ±‚çš„æœåŠ¡å™¨ï¼Œå¦‚æœè¿™å°æœåŠ¡å™¨éƒ¨ç½²äº†å¤šä¸ªå®ä¾‹ï¼Œåˆ™éœ€è¦å»æ¯ä¸ªåº”ç”¨å®ä¾‹çš„æ—¥å¿—ç›®å½•ä¸‹å»æ‰¾æ—¥å¿—æ–‡ä»¶ã€‚æ¯ä¸ªåº”ç”¨å®ä¾‹è¿˜ä¼šè®¾ç½®æ—¥å¿—æ»šåŠ¨ç­–ç•¥ï¼ˆå¦‚ï¼šæ¯å¤©ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼‰ï¼Œè¿˜æœ‰æ—¥å¿—å‹ç¼©å½’æ¡£ç­–ç•¥ç­‰ã€‚

å› æ­¤ï¼Œæ—¥å¿—æ•°æ®åœ¨ä»¥ä¸‹å‡ æ–¹é¢å…·æœ‰éå¸¸é‡è¦çš„ä½œç”¨ï¼š

- **æ•°æ®æŸ¥æ‰¾**ï¼šé€šè¿‡æ£€ç´¢æ—¥å¿—ä¿¡æ¯ï¼Œå®šä½ç›¸åº”çš„ bug ï¼Œæ‰¾å‡ºè§£å†³æ–¹æ¡ˆ
- **æœåŠ¡è¯Šæ–­**ï¼šé€šè¿‡å¯¹æ—¥å¿—ä¿¡æ¯è¿›è¡Œç»Ÿè®¡ã€åˆ†æï¼Œäº†è§£æœåŠ¡å™¨çš„è´Ÿè·å’ŒæœåŠ¡è¿è¡ŒçŠ¶æ€
- **æ•°æ®åˆ†æ**ï¼šå¯ä»¥åšè¿›ä¸€æ­¥çš„æ•°æ®åˆ†æ

é’ˆå¯¹è¿™äº›é—®é¢˜ï¼Œä¸ºäº†æä¾›åˆ†å¸ƒå¼çš„å®æ—¶æ—¥å¿—æœé›†å’Œåˆ†æçš„ç›‘æ§ç³»ç»Ÿï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¸šç•Œé€šç”¨çš„æ—¥å¿—æ•°æ®ç®¡ç†è§£å†³æ–¹æ¡ˆâ€”â€”å³åŸºäºELKçš„æ—¥å¿—æ”¶é›†ä¸­å¿ƒã€‚è¯¥æ¨¡å—å°†ä¼šçš„æ˜¯å…¬å¸å¾®æœåŠ¡å¹³å°ç»„æˆä¸­é‡è¦ä¸€ç¯ï¼Œå®ƒèƒ½ç»™å¼€å‘è€…ã€æµ‹è¯•è€…ã€è¿ç»´è€…ã€ä»¥åŠç”¨æˆ·æä¾›æ›´åŠ ä¾¿åˆ©çš„é€”å¾„å»æŸ¥çœ‹é¡¹ç›®çš„å¼‚å¸¸ä¿¡æ¯ï¼Œè¿˜èƒ½åŠæ—¶çš„å‘å‡ºå¼‚å¸¸å‘Šè­¦ä¿¡æ¯æ¥æç¤ºè¿ç»´è€…åŠæ—¶çš„è¿›è¡Œç³»ç»Ÿçš„ç»´æŠ¤ã€‚



## 1.3 æœ¯è¯­å®šä¹‰

| æœ¯è¯­          | æè¿°                                                         |
| ------------- | ------------------------------------------------------------ |
| ELK           | ELKæ˜¯ä¸‰ä¸ªå¼€æºè½¯ä»¶çš„ç¼©å†™ï¼Œåˆ†åˆ«è¡¨ç¤ºï¼šElasticsearch , Logstash, Kibana = **æœç´¢+è¿‡æ»¤+å¯è§†åŒ–** |
| Flilebeat     | è½»é‡çº§çš„æ—¥å¿—æ”¶é›†å™¨                                           |
| ElasticSearch | å¼€æºåˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œæä¾›æœé›†ã€åˆ†æã€å­˜å‚¨æ•°æ®ä¸‰å¤§åŠŸèƒ½         |
| Logstash      | æ—¥å¿—çš„æœé›†ã€åˆ†æã€è¿‡æ»¤æ—¥å¿—çš„å·¥å…·ï¼Œæ”¯æŒå¤§é‡çš„æ•°æ®è·å–æ–¹å¼     |
| Kibana        | ç”¨äº**å¯è§†åŒ–**ï¼Œèƒ½æä¾›å‹å¥½çš„æ•°æ®åˆ†æç•Œé¢                     |
| lucene        | ä¸€å¥—ä¿¡æ¯**æ£€ç´¢å·¥å…·åŒ…**ï¼ˆåŒ…å«ç´¢å¼•ç»“æ„ã€æ’åºã€æœç´¢è§„åˆ™ï¼Œä¸åŒ…æ‹¬æœç´¢å¼•æ“ï¼‰ï¼Œ ElasticsearchåŸºäºlunceneè¿›è¡Œå°è£…å¢å¼º |



## 1.4 å‚è€ƒèµ„æ–™



* https://www.elastic.co/guide/en/logstash/6.1/index.html

* https://docs.fluentd.org

* https://blog.51cto.com/13527416/2132270

* https://elasticsearch.cn/article/190

* https://www.elastic.co/guide/en/beats/filebeat/6.1/filebeat-overview.html

- æŸ¥çœ‹[ELK å®˜æ–¹ç½‘ç«™](https://www.elastic.co/)ï¼Œäº†è§£ ELK+Beats ç­‰äº§å“çš„ä»‹ç»ï¼›
- æœç´¢[ELK è®ºå›](https://discuss.elastic.co/)ï¼Œå¯»æ‰¾å…³äº ELK åœ¨å®é™…ä½¿ç”¨ä¸­çš„é—®é¢˜åŠè§£ç­”ï¼›
- æŸ¥çœ‹æ–‡ç« [éƒ¨ç½²å’Œæ‰©å±• ELK](https://www.elastic.co/guide/en/logstash/current/deploying-and-scaling.html)ï¼Œäº†è§£æ›´å¤šå…³äºå¦‚ä½•æ‰©å±• ELK æ¶æ„çš„çŸ¥è¯†ï¼›
- å‚è€ƒ[ä½¿ç”¨ Nginx å®ç° Kibana ç™»é™†è®¤è¯](http://www.cnblogs.com/yjmyzz/p/filebeat-turorial-and-kibana-login-setting-with-nginx.html)åšå®¢ï¼Œå­¦ä¹ å¦‚ä½•é…ç½® Nginx ä½œä¸º Kibana çš„åå‘ä»£ç†ï¼Œä¸”å®ç°ç™»é™†è®¤è¯ï¼›
- æŸ¥é˜…[Filebeat æ–‡æ¡£](https://www.elastic.co/guide/en/beats/filebeat/1.2/filebeat-overview.html)ï¼Œç³»ç»Ÿå…¨é¢åœ°å­¦ä¹  Filebeat çš„å®‰è£…é…ç½®ç»†èŠ‚ï¼›
- æŸ¥é˜…[Elasticsearch æ–‡æ¡£](https://www.elastic.co/guide/en/elasticsearch/reference/2.3/getting-started.html)ï¼Œç³»ç»Ÿå…¨é¢åœ°å­¦ä¹  Elasticsearch çš„å®‰è£…é…ç½®ç»†èŠ‚ï¼›
- æŸ¥é˜…[Logstash æ–‡æ¡£](https://www.elastic.co/guide/en/logstash/2.3/installing-logstash.html)ï¼Œç³»ç»Ÿå…¨é¢åœ°å­¦ä¹  Logstash çš„å®‰è£…é…ç½®ç»†èŠ‚ï¼›
- æŸ¥é˜…[Kibana æ–‡æ¡£](https://www.elastic.co/guide/en/kibana/4.5/introduction.html)ï¼Œç³»ç»Ÿå…¨é¢åœ°å­¦ä¹  Kibana çš„å®‰è£…é…ç½®ç»†èŠ‚ã€‚



# 2 æ€»ä½“è®¾è®¡

## 2.1 æ–¹æ¡ˆé€‰å‹

ä¸€ä¸ªå®Œæ•´çš„æ—¥å¿—ä¸­å¿ƒä¸€èˆ¬åŒ…å«ä¸€ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š

â€‹	â— æ”¶é›†ï¼èƒ½å¤Ÿé‡‡é›†å¤šç§æ¥æºçš„æ—¥å¿—æ•°æ®

â€‹	â— ä¼ è¾“ï¼èƒ½å¤Ÿç¨³å®šçš„æŠŠæ—¥å¿—æ•°æ®ä¼ è¾“åˆ°ä¸­å¤®ç³»ç»Ÿ

â€‹	â— å­˜å‚¨ï¼å¦‚ä½•å­˜å‚¨æ—¥å¿—æ•°æ®

â€‹	â— åˆ†æï¼å¯ä»¥æ”¯æŒ UI åˆ†æ

â€‹	â— å‘Šè­¦ï¼èƒ½å¤Ÿæä¾›é”™è¯¯æŠ¥å‘Šï¼Œç›‘æ§æœºåˆ¶



ç”±æ­¤äº§ç”Ÿçš„äº§å“æˆ–è€…æ–¹æ¡ˆå¦‚ä¸‹ï¼š

* Scribe â€“ Scribeæ˜¯ç”±Facebookå¼€æºçš„ï¼Œä¸»æ‰“å¯æ‰©å±•æ€§å’Œå¯é  æ€§çš„æ—¥å¿—èšåˆæœåŠ¡ï¼Œç”±C++ç¼–å†™ï¼Œä½¿ç”¨Thrifté€šä¿¡åè®®ï¼Œä½†æ˜¯ å®é™…ä¸Šå¯ä»¥æ”¯æŒä»»ä½•è¯­è¨€ã€‚

* Flume â€“ Flumeæ˜¯apacheçš„é¡¹ç›®ï¼Œæ—¨åœ¨æ”¶é›†ï¼Œèšåˆï¼Œç§»åŠ¨å¤§ é‡çš„æ—¥å¿—æ•°æ®ï¼Œæœ€ç»ˆå°†æ•°æ®å­˜æ”¾åˆ°HDFSä¸Šã€‚

* Chukwa â€“ Chukwaæ˜¯å¦å¤–ä¸€ä¸ªapacheé¡¹ç›®ç”¨æ¥å°†æ—¥å¿—æ”¾åˆ°HDFSä¸­ã€‚

* fluent â€“ fluent å’Œlogstashç±»ä¼¼ï¼Œä¹Ÿæ”¯æŒå„ç§è¾“å…¥å’Œè¾“å‡ºï¼Œè™½ç„¶ä¸æ”¯æŒä»»ä½•å­˜å‚¨å±‚ï¼Œä½†æ˜¯å¯é…ç½®ã€‚å¦å¤–ï¼Œå®ƒçš„è®¾è®¡åŸåˆ™æ˜¯æ–¹ä¾¿å®‰è£…å’Œä½å¼€é”€ã€‚

* kafka â€“ ç”±LinkInå¼€å‘çš„ç”¨æ¥å¤„ç†ä»–ä»¬çš„æ´»åŠ¨æµï¼ˆactivity streamï¼‰ï¼Œç°åœ¨æ˜¯apacheçš„å­µåŒ–é¡¹ç›®ã€‚è™½ç„¶kafkaå¯ç”¨ä½œä¸ºæ—¥å¿— æ”¶é›†å™¨ï¼Œä¸è¿‡ä¸æ˜¯ä»–çš„ä¸»è¦ä½¿ç”¨åœºæ™¯ã€‚éœ€è¦é…ç½®Zookeeperæ¥ ç®¡ç†é›†ç¾¤ã€‚

* `ELK` - ELKç›¸å¯¹äºå…¶ä»–å•ä¸€äº§å“æˆ–ç³»ç»Ÿæä¾›äº†ä¸€æ•´å¥—è§£å†³æ–¹æ¡ˆï¼Œå®ƒæ˜¯ä¸‰ä¸ªè½¯ä»¶äº§å“çš„é¦–å­—æ¯ç¼©å†™ï¼ŒElasticsearchã€Logstash å’Œ Kibanaã€‚è¿™ä¸‰æ¬¾è½¯ä»¶éƒ½æ˜¯å¼€æºè½¯ä»¶ï¼Œé€šå¸¸æ˜¯é…åˆä½¿ç”¨ï¼Œè€Œä¸”åˆå…ˆåå½’äº [http://Elastic.co](https://www.elastic.co/cn/)å…¬å¸åä¸‹ï¼Œæ•…è¢«ç®€ç§°ä¸ºELKåè®®æ ˆã€‚

  

### ä»‹ç»

#### ![ElasticSearch](https://gitee.com/JungwooJava/cloudimg/raw/master/ElasticSearch.png)Elasticsearch

Elasticsearch æ˜¯ä¸€ä¸ªå®æ—¶çš„åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ï¼Œå®ƒå¯ä»¥ç”¨äºå…¨æ–‡æœç´¢ï¼Œç»“æ„åŒ–æœç´¢ä»¥åŠåˆ†æã€‚	å®ƒæ˜¯ä¸€ä¸ªå»ºç«‹åœ¨å…¨æ–‡æœç´¢å¼•æ“ Apache Lucene åŸºç¡€ä¸Šçš„æœç´¢å¼•æ“ï¼Œä½¿ç”¨ Java è¯­è¨€ç¼–å†™ã€‚ä¸»è¦ç‰¹ç‚¹å¦‚	ä¸‹ï¼š

â€‹		â– å®æ—¶åˆ†æ

â€‹		â– åˆ†å¸ƒå¼å®æ—¶æ–‡ä»¶å­˜å‚¨ï¼Œå¹¶å°†æ¯ä¸€ä¸ªå­—æ®µéƒ½ç¼–å…¥ç´¢å¼•

â€‹		â– æ–‡æ¡£å¯¼å‘ï¼Œæ‰€æœ‰çš„å¯¹è±¡å…¨éƒ¨æ˜¯æ–‡æ¡£

â€‹		â– é«˜å¯ç”¨æ€§ï¼Œæ˜“æ‰©å±•ï¼Œæ”¯æŒé›†ç¾¤ï¼ˆClusterï¼‰ã€åˆ†ç‰‡å’Œå¤åˆ¶ï¼ˆShards å’Œ Replicasï¼‰

â€‹		â– æ¥å£å‹å¥½ï¼Œæ”¯æŒ JSON



```text
Elasticsearchæœ€å…³é”®çš„å°±æ˜¯æä¾›å¼ºå¤§çš„ç´¢å¼•èƒ½åŠ›ã€‚

Elasticsearchç´¢å¼•çš„ç²¾é«“ï¼šä¸€åˆ‡è®¾è®¡éƒ½æ˜¯ä¸ºäº†æé«˜æœç´¢çš„æ€§èƒ½

Elasticsearchä¼˜åŠ¿
1.æ¨ªå‘å¯æ‰©å±•æ€§:åªéœ€è¦å¢åŠ æœåŠ¡å™¨ï¼Œåšä¸€ç‚¹å„¿é…ç½®ï¼Œå¯åŠ¨ä¸€ä¸‹Elasticsearchå°±å¯ä»¥å¹¶å…¥é›†ç¾¤ã€‚
2.åˆ†ç‰‡æœºåˆ¶æä¾›æ›´å¥½çš„åˆ†å¸ƒæ€§:åŒä¸€ä¸ªç´¢å¼•åˆ†æˆå¤šä¸ªåˆ†ç‰‡, åˆ†è€Œæ²»ä¹‹çš„æ–¹å¼å¯æå‡å¤„ç†æ•ˆç‡ã€‚
3.é«˜å¯ç”¨:æä¾›å¤åˆ¶( replica) æœºåˆ¶ï¼Œä¸€ä¸ªåˆ†ç‰‡å¯ä»¥è®¾ç½®å¤šä¸ªå¤åˆ¶ï¼Œä½¿å¾—æŸå°æœåŠ¡å™¨åœ¨å®•æœºçš„æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä»æ—§å¯ä»¥ç…§å¸¸è¿è¡Œï¼Œå¹¶ä¼šæŠŠæœåŠ¡å™¨å®•æœºä¸¢å¤±çš„æ•°æ®ä¿¡æ¯å¤åˆ¶æ¢å¤åˆ°å…¶ä»–å¯ç”¨èŠ‚ç‚¹ä¸Šã€‚
4.ä½¿ç”¨ç®€å•:å…±éœ€ä¸€æ¡å‘½ä»¤å°±å¯ä»¥ä¸‹è½½æ–‡ä»¶ï¼Œç„¶åå¾ˆå¿«å°±èƒ½æ­å»ºä¸€ä¸€ä¸ªç«™å†…æœç´¢å¼•æ“ã€‚

Elasticsearchå­˜å‚¨ç»“æ„
Elasticsearchæ˜¯æ–‡ä»¶å­˜å‚¨ï¼ŒElasticsearchæ˜¯é¢å‘æ–‡æ¡£å‹æ•°æ®åº“ï¼Œä¸€æ¡æ•°æ®åœ¨è¿™é‡Œå°±æ˜¯ä¸€ä¸ªæ–‡æ¡£
```



#### ![Logstash](https://gitee.com/JungwooJava/cloudimg/raw/master/Logstash.png)Logstash

Logstashæ˜¯å¼€æºæ•°æ®æ”¶é›†å¼•æ“ï¼Œå…·æœ‰å®æ—¶ç®¡é“åŠŸèƒ½ã€‚ä½¿ç”¨ JRuby è¯­è¨€ç¼–å†™ã€‚å…¶ä½œè€…æ˜¯ä¸–ç•Œè‘—åçš„è¿ç»´	å·¥ç¨‹å¸ˆä¹”ä¸¹Â·è¥¿å¡ (Jordan Sissel)ã€‚ä¸»è¦ç‰¹ç‚¹å¦‚ä¸‹ï¼š

â– å‡ ä¹å¯ä»¥è®¿é—®ä»»ä½•æ•°æ® 

â– å¯ä»¥å’Œå¤šç§å¤–éƒ¨åº”ç”¨ç»“åˆ

â– æ”¯æŒå¼¹æ€§æ‰©å±•

å®ƒç”±ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ç»„æˆï¼š

â— Shipperï¼å‘é€æ—¥å¿—æ•°æ®

â— Brokerï¼æ”¶é›†æ•°æ®ï¼Œç¼ºçœå†…ç½® Redis

â— Indexerï¼æ•°æ®å†™å…¥



##### âœ…**ä¼˜åŠ¿**

Logstash ä¸»è¦çš„ä¼˜ç‚¹å°±æ˜¯å®ƒçš„çµæ´»æ€§ï¼Œä¸»è¦å› ä¸ºå®ƒæœ‰å¾ˆå¤šæ’ä»¶ï¼Œè¯¦ç»†çš„æ–‡æ¡£ä»¥åŠç›´ç™½çš„é…ç½®æ ¼å¼è®©å®ƒå¯ä»¥åœ¨å¤šç§åœºæ™¯ä¸‹åº”ç”¨ã€‚æˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥åœ¨ç½‘ä¸Šæ‰¾åˆ°å¾ˆå¤šèµ„æºï¼Œå‡ ä¹å¯ä»¥å¤„ç†ä»»ä½•é—®é¢˜ã€‚



##### **âåŠ£åŠ¿**

Logstash è‡´å‘½çš„é—®é¢˜æ˜¯å®ƒçš„`æ€§èƒ½`ä»¥åŠ`èµ„æºæ¶ˆè€—`(é»˜è®¤çš„å †å¤§å°æ˜¯ 1GB)ã€‚å°½ç®¡å®ƒçš„æ€§èƒ½åœ¨è¿‘å‡ å¹´å·²ç»æœ‰å¾ˆå¤§æå‡ï¼Œä¸å®ƒçš„æ›¿ä»£è€…ä»¬ç›¸æ¯”è¿˜æ˜¯è¦æ…¢å¾ˆå¤šçš„ã€‚è¿™é‡Œæœ‰ Logstash ä¸ rsyslog æ€§èƒ½å¯¹æ¯”ä»¥åŠLogstash ä¸ filebeat çš„æ€§èƒ½å¯¹æ¯”ã€‚å®ƒåœ¨å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ä¼šæ˜¯ä¸ªé—®é¢˜ã€‚

å¦ä¸€ä¸ªé—®é¢˜æ˜¯å®ƒç›®å‰`ä¸æ”¯æŒç¼“å­˜`ï¼Œç›®å‰çš„å…¸å‹æ›¿ä»£æ–¹æ¡ˆæ˜¯å°† Redis æˆ– Kafka ä½œä¸ºä¸­å¿ƒç¼“å†²æ± ã€‚

â€‹	

##### ğŸŒ**å…¸å‹åº”ç”¨åœºæ™¯**

å› ä¸º Logstash è‡ªèº«çš„çµæ´»æ€§ä»¥åŠç½‘ç»œä¸Šä¸°å¯Œçš„èµ„æ–™ï¼ŒLogstash é€‚ç”¨äºåŸå‹éªŒè¯é˜¶æ®µä½¿ç”¨ï¼Œæˆ–è€…è§£æéå¸¸å¤æ‚çš„æ—¶å€™ã€‚åœ¨ä¸è€ƒè™‘æœåŠ¡å™¨èµ„æºçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæœåŠ¡å™¨çš„æ€§èƒ½è¶³å¤Ÿå¥½ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ºæ¯å°æœåŠ¡å™¨å®‰è£… Logstash ã€‚æˆ‘ä»¬ä¹Ÿä¸éœ€è¦ä½¿ç”¨ç¼“å†²ï¼Œå› ä¸ºæ–‡ä»¶è‡ªèº«å°±æœ‰ç¼“å†²çš„è¡Œä¸ºï¼Œè€Œ Logstash ä¹Ÿä¼šè®°ä½ä¸Šæ¬¡å¤„ç†çš„ä½ç½®ã€‚

å¦‚æœæœåŠ¡å™¨æ€§èƒ½è¾ƒå·®ï¼Œå¹¶ä¸æ¨èä¸ºæ¯ä¸ªæœåŠ¡å™¨å®‰è£… Logstash ï¼Œè¿™æ ·å°±éœ€è¦ä¸€ä¸ªè½»é‡çš„æ—¥å¿—ä¼ è¾“å·¥å…·ï¼Œå°†æ•°æ®ä»æœåŠ¡å™¨ç«¯ç»ç”±ä¸€ä¸ªæˆ–å¤šä¸ª Logstash ä¸­å¿ƒæœåŠ¡å™¨ä¼ è¾“åˆ° Elasticsearchã€‚

éšç€æ—¥å¿—é¡¹ç›®çš„æ¨è¿›ï¼Œå¯èƒ½ä¼šå› ä¸ºæ€§èƒ½æˆ–ä»£ä»·çš„é—®é¢˜ï¼Œéœ€è¦è°ƒæ•´æ—¥å¿—ä¼ è¾“çš„æ–¹å¼(log shipper)ã€‚å½“åˆ¤æ–­ Logstash çš„æ€§èƒ½æ˜¯å¦è¶³å¤Ÿå¥½æ—¶ï¼Œé‡è¦çš„æ˜¯å¯¹ååé‡çš„éœ€æ±‚æœ‰ç€å‡†ç¡®çš„ä¼°è®¡ï¼Œè¿™ä¹Ÿå†³å®šäº†éœ€è¦ä¸º Logstash æŠ•å…¥å¤šå°‘ç¡¬ä»¶èµ„æºã€‚



#### Filebeat

ç”±äº Logstash åœ¨æ•°æ®æ”¶é›†ä¸Šå¹¶ä¸å‡ºè‰²ï¼Œè€Œä¸”ä½œä¸º Agentï¼Œå…¶æ€§èƒ½å¹¶ä¸è¾¾æ ‡ã€‚åŸºäºæ­¤ï¼ŒElastic å‘å¸ƒäº† beats ç³»åˆ—è½»é‡çº§é‡‡é›†ç»„ä»¶ã€‚ä½œä¸º Beats å®¶æ—çš„ä¸€å‘˜ï¼ŒFilebeat æ˜¯ä¸€ä¸ªè½»é‡çº§çš„æ—¥å¿—ä¼ è¾“å·¥å…·ï¼ŒFilebeat å¯ä»¥å°†æ—¥å¿—æ¨é€åˆ°ä¸­å¿ƒ Logstashã€‚



##### âœ…**ä¼˜åŠ¿**

Filebeat åªæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ²¡æœ‰ä»»ä½•ä¾èµ–ã€‚å®ƒå ç”¨èµ„æºæå°‘ï¼Œå°½ç®¡å®ƒè¿˜ååˆ†å¹´è½»ï¼Œæ­£å¼å› ä¸ºå®ƒç®€å•ï¼Œæ‰€ä»¥å‡ ä¹æ²¡æœ‰ä»€ä¹ˆå¯ä»¥å‡ºé”™çš„åœ°æ–¹ï¼Œæ‰€ä»¥å®ƒçš„å¯é æ€§è¿˜æ˜¯å¾ˆé«˜çš„ã€‚å®ƒä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†å¾ˆå¤šå¯ä»¥è°ƒèŠ‚çš„ç‚¹ï¼Œä¾‹å¦‚ï¼šå®ƒä»¥ä½•ç§æ–¹å¼æœç´¢æ–°çš„æ–‡ä»¶ï¼Œä»¥åŠå½“æ–‡ä»¶æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä½•æ—¶é€‰æ‹©å…³é—­æ–‡ä»¶å¥æŸ„ã€‚



##### â**åŠ£åŠ¿**

Filebeat çš„åº”ç”¨èŒƒå›´ååˆ†æœ‰é™ï¼Œæ‰€ä»¥åœ¨æŸäº›åœºæ™¯ä¸‹æˆ‘ä»¬ä¼šç¢°åˆ°é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨ Logstash ä½œä¸ºä¸‹æ¸¸ç®¡é“ï¼Œæˆ‘ä»¬åŒæ ·ä¼šé‡åˆ°æ€§èƒ½é—®é¢˜ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼ŒFilebeat çš„èŒƒå›´åœ¨æ‰©å¤§ã€‚å¼€å§‹æ—¶ï¼Œå®ƒåªèƒ½å°†æ—¥å¿—å‘é€åˆ° Logstash å’Œ Elasticsearchï¼Œè€Œç°åœ¨å®ƒå¯ä»¥å°†æ—¥å¿—å‘é€ç»™ Kafka å’Œ Redisï¼Œåœ¨ 5.x ç‰ˆæœ¬ä¸­ï¼Œå®ƒè¿˜å…·å¤‡è¿‡æ»¤çš„èƒ½åŠ›ã€‚



##### ğŸŒ**å…¸å‹åº”ç”¨åœºæ™¯**

Filebeat åœ¨è§£å†³æŸäº›ç‰¹å®šçš„é—®é¢˜æ—¶ï¼šæ—¥å¿—å­˜äºæ–‡ä»¶ï¼Œæˆ‘ä»¬å¸Œæœ›å°†æ—¥å¿—ç›´æ¥ä¼ è¾“å­˜å‚¨åˆ° Elasticsearchã€‚è¿™ä»…åœ¨æˆ‘ä»¬åªæ˜¯æŠ“å»(grep)å®ƒä»¬æˆ–è€…æ—¥å¿—æ˜¯å­˜äº JSON æ ¼å¼(Filebeat å¯ä»¥è§£æ JSON)ã€‚æˆ–è€…å¦‚æœæ‰“ç®—ä½¿ç”¨ Elasticsearch çš„ Ingest åŠŸèƒ½å¯¹æ—¥å¿—è¿›è¡Œè§£æå’Œä¸°å¯Œã€‚

å°†æ—¥å¿—å‘é€åˆ° Kafka/Redisã€‚æ‰€ä»¥å¦å¤–ä¸€ä¸ªä¼ è¾“å·¥å…·(ä¾‹å¦‚ï¼ŒLogstash æˆ–è‡ªå®šä¹‰çš„ Kafka æ¶ˆè´¹è€…)å¯ä»¥è¿›ä¸€æ­¥ä¸°å¯Œå’Œè½¬å‘ã€‚è¿™é‡Œå‡è®¾é€‰æ‹©çš„ä¸‹æ¸¸ä¼ è¾“å·¥å…·èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬å¯¹åŠŸèƒ½å’Œæ€§èƒ½çš„è¦æ±‚ã€‚

> ä¸ºä»€ä¹ˆç”¨ Filebeat ï¼Œè€Œä¸ç”¨åŸæ¥çš„ Logstash å‘¢ï¼Ÿ

è‡³æ­¤ï¼ŒåŸå› æ¯”è¾ƒæ˜äº†ï¼Œèµ„æºæ¶ˆè€—æ¯”è¾ƒå¤§ã€‚

ç”±äº Logstash æ˜¯è·‘åœ¨ JVM ä¸Šé¢ï¼Œèµ„æºæ¶ˆè€—æ¯”è¾ƒå¤§ï¼Œåæ¥ä½œè€…ç”¨ GO å†™äº†ä¸€ä¸ªåŠŸèƒ½è¾ƒå°‘ä½†æ˜¯èµ„æºæ¶ˆè€—ä¹Ÿå°çš„è½»é‡çº§çš„ Agent å« Logstash-forwarderã€‚

åæ¥ä½œè€…åŠ å…¥ elastic.co å…¬å¸ï¼Œ Logstash-forwarder çš„å¼€å‘å·¥ä½œç»™å…¬å¸å†…éƒ¨ GO å›¢é˜Ÿæ¥æï¼Œæœ€åå‘½åä¸º Filebeatã€‚

Filebeat éœ€è¦éƒ¨ç½²åœ¨æ¯å°åº”ç”¨æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥é€šè¿‡ Salt æ¥æ¨é€å¹¶å®‰è£…é…ç½®ã€‚



#### **Fluentd**

Fluentd åˆ›å»ºçš„åˆè¡·ä¸»è¦æ˜¯å°½å¯èƒ½çš„ä½¿ç”¨ JSON ä½œä¸ºæ—¥å¿—è¾“å‡ºï¼Œæ‰€ä»¥ä¼ è¾“å·¥å…·åŠå…¶ä¸‹æ¸¸çš„ä¼ è¾“çº¿ä¸éœ€è¦çŒœæµ‹å­å­—ç¬¦ä¸²é‡Œé¢å„ä¸ªå­—æ®µçš„ç±»å‹ã€‚è¿™æ ·ï¼Œå®ƒä¸ºå‡ ä¹æ‰€æœ‰çš„è¯­è¨€éƒ½æä¾›åº“ï¼Œè¿™ä¹Ÿæ„å‘³ç€ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒæ’å…¥åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ç¨‹åºä¸­ã€‚



##### **âœ…ä¼˜åŠ¿**

å’Œå¤šæ•° Logstash æ’ä»¶ä¸€æ ·ï¼ŒFluentd æ’ä»¶æ˜¯ç”¨ Ruby è¯­è¨€å¼€å‘çš„éå¸¸æ˜“äºç¼–å†™ç»´æŠ¤ã€‚æ‰€ä»¥å®ƒæ•°é‡å¾ˆå¤šï¼Œå‡ ä¹æ‰€æœ‰çš„æºå’Œç›®æ ‡å­˜å‚¨éƒ½æœ‰æ’ä»¶(å„ä¸ªæ’ä»¶çš„æˆç†Ÿåº¦ä¹Ÿä¸å¤ªä¸€æ ·)ã€‚è¿™ä¹Ÿæ„å‘³è¿™æˆ‘ä»¬å¯ä»¥ç”¨ Fluentd æ¥ä¸²è”æ‰€æœ‰çš„ä¸œè¥¿ã€‚



##### **â**åŠ£åŠ¿

å› ä¸ºåœ¨å¤šæ•°åº”ç”¨åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ Fluentd å¾—åˆ°ç»“æ„åŒ–çš„æ•°æ®ï¼Œå®ƒçš„çµæ´»æ€§å¹¶ä¸å¥½ã€‚ä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ¥è§£æéç»“æ„åŒ–çš„æ•°æ®ã€‚å°½ç®¡ï¼Œæ€§èƒ½åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹éƒ½å¾ˆå¥½ï¼Œä½†å’Œ syslog-ngä¸€æ ·ï¼Œå®ƒçš„ç¼“å†²åªå­˜åœ¨ä¸è¾“å‡ºç«¯ï¼Œå•çº¿ç¨‹æ ¸å¿ƒä»¥åŠ Ruby GIL å®ç°çš„æ’ä»¶æ„å‘³ç€å®ƒå¤§çš„èŠ‚ç‚¹ä¸‹æ€§èƒ½æ˜¯å—é™çš„ï¼Œä¸è¿‡å®ƒçš„èµ„æºæ¶ˆè€—åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹æ˜¯å¯ä»¥æ¥å—çš„ã€‚å¯¹äºå°çš„æˆ–è€…åµŒå…¥å¼çš„è®¾å¤‡ï¼Œå¯èƒ½éœ€è¦çœ‹çœ‹ Fluent Bitï¼Œå®ƒå’Œ Fluentd çš„å…³ç³»ä¸ Filebeat å’Œ Logstash ä¹‹é—´çš„å…³ç³»ç±»ä¼¼ã€‚



##### ğŸ’ Logstashå¯¹æ¯”Fluentd

![img](https://pic4.zhimg.com/80/v2-48e462b77b576e6577466a3ab3d1133f_720w.jpg)



##### **ğŸŒå…¸å‹åº”ç”¨åœºæ™¯**

Fluentd åœ¨æ—¥å¿—çš„æ•°æ®æºå’Œç›®æ ‡å­˜å‚¨å„ç§å„æ ·æ—¶éå¸¸åˆé€‚ï¼Œå› ä¸ºå®ƒæœ‰å¾ˆå¤šæ’ä»¶ã€‚è€Œä¸”ï¼Œå¦‚æœå¤§å¤šæ•°æ•°æ®æºéƒ½æ˜¯è‡ªå®šä¹‰çš„åº”ç”¨ï¼Œæ‰€ä»¥å¯ä»¥å‘ç°ç”¨ Fluentd çš„åº“è¦æ¯”å°†æ—¥å¿—åº“ä¸å…¶ä»–ä¼ è¾“å·¥å…·ç»“åˆèµ·æ¥è¦å®¹æ˜“å¾ˆå¤šã€‚ç‰¹åˆ«æ˜¯åœ¨æˆ‘ä»¬çš„åº”ç”¨æ˜¯å¤šç§è¯­è¨€ç¼–å†™çš„æ—¶å€™ï¼Œå³æˆ‘ä»¬ä½¿ç”¨äº†å¤šç§æ—¥å¿—åº“ï¼Œæ—¥å¿—çš„è¡Œä¸ºä¹Ÿä¸å¤ªä¸€æ ·ã€‚



#### **Logagent**

Logagent æ˜¯ Sematext æä¾›çš„ä¼ è¾“å·¥å…·ï¼Œå®ƒç”¨æ¥å°†æ—¥å¿—ä¼ è¾“åˆ° Logsene(ä¸€ä¸ªåŸºäº SaaS å¹³å°çš„ Elasticsearch API)ï¼Œå› ä¸º Logsene ä¼šæš´éœ² Elasticsearch APIï¼Œæ‰€ä»¥ Logagent å¯ä»¥å¾ˆå®¹æ˜“å°†æ•°æ®æ¨é€åˆ° Elasticsearch ã€‚

![è¯¦è§£æ—¥å¿—é‡‡é›†å·¥å…·--Logstashã€Filebeatã€Fluentdã€Logagentå¯¹æ¯”](https://s4.51cto.com/oss/201904/25/8918e955c0b67259b9c19bda039718a4.jpeg)



##### âœ…**ä¼˜åŠ¿**

å¯ä»¥è·å– /var/log ä¸‹çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè§£æå„ç§æ ¼å¼(Elasticsearchï¼ŒSolrï¼ŒMongoDBï¼ŒApache HTTPDç­‰ç­‰)ï¼Œå®ƒå¯ä»¥æ©ç›–æ•æ„Ÿçš„æ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œä¸ªäººéªŒè¯ä¿¡æ¯ï¼Œå‡ºç”Ÿå¹´æœˆæ—¥ï¼Œä¿¡ç”¨å¡å·ç ï¼Œç­‰ç­‰ã€‚å®ƒè¿˜å¯ä»¥åŸºäº IP åš GeoIP ä¸°å¯Œåœ°ç†ä½ç½®ä¿¡æ¯(ä¾‹å¦‚ï¼Œaccess logs)ã€‚åŒæ ·ï¼Œå®ƒè½»é‡åˆå¿«é€Ÿï¼Œå¯ä»¥å°†å…¶ç½®å…¥ä»»ä½•æ—¥å¿—å—ä¸­ã€‚åœ¨æ–°çš„ 2.0 ç‰ˆæœ¬ä¸­ï¼Œå®ƒä»¥ç¬¬ä¸‰æ–¹ node.js æ¨¡å—åŒ–æ–¹å¼å¢åŠ äº†æ”¯æŒå¯¹è¾“å…¥è¾“å‡ºçš„å¤„ç†æ’ä»¶ã€‚é‡è¦çš„æ˜¯ Logagent æœ‰æœ¬åœ°ç¼“å†²ï¼Œæ‰€ä»¥ä¸åƒ Logstash ï¼Œåœ¨æ•°æ®ä¼ è¾“ç›®çš„åœ°ä¸å¯ç”¨æ—¶ä¼šä¸¢å¤±æ—¥å¿—ã€‚



##### **âåŠ£åŠ¿**

å°½ç®¡ Logagent æœ‰äº›æ¯”è¾ƒæœ‰æ„æ€çš„åŠŸèƒ½(ä¾‹å¦‚ï¼Œæ¥æ”¶ Heroku æˆ– CloudFoundry æ—¥å¿—)ï¼Œä½†æ˜¯å®ƒå¹¶æ²¡æœ‰ Logstash çµæ´»ã€‚



##### ğŸŒ**å…¸å‹åº”ç”¨åœºæ™¯**

Logagent ä½œä¸ºä¸€ä¸ªå¯ä»¥åšæ‰€æœ‰äº‹æƒ…çš„ä¼ è¾“å·¥å…·æ˜¯å€¼å¾—é€‰æ‹©çš„(æå–ã€è§£æã€ç¼“å†²å’Œä¼ è¾“)ã€‚



#### **logtail**



é˜¿é‡Œäº‘æ—¥å¿—æœåŠ¡çš„ç”Ÿäº§è€…ï¼Œç›®å‰åœ¨é˜¿é‡Œé›†å›¢å†…éƒ¨æœºå™¨ä¸Šè¿è¡Œï¼Œç»è¿‡3å¹´å¤šæ—¶é—´çš„è€ƒéªŒï¼Œç›®å‰ä¸ºé˜¿é‡Œå…¬æœ‰äº‘ç”¨æˆ·æä¾›æ—¥å¿—æ”¶é›†æœåŠ¡ã€‚



![è¯¦è§£æ—¥å¿—é‡‡é›†å·¥å…·--Logstashã€Filebeatã€Fluentdã€Logagentå¯¹æ¯”](https://s3.51cto.com/oss/201904/25/a077ff1207ee753462e50078bd908c62.jpeg)

é‡‡ç”¨C++è¯­è¨€å®ç°ï¼Œå¯¹ç¨³å®šæ€§ã€èµ„æºæ§åˆ¶ã€ç®¡ç†ç­‰ä¸‹è¿‡å¾ˆå¤§çš„åŠŸå¤«ï¼Œæ€§èƒ½è‰¯å¥½ã€‚ç›¸æ¯”äºlogstashã€fluentdçš„ç¤¾åŒºæ”¯æŒï¼ŒlogtailåŠŸèƒ½è¾ƒä¸ºå•ä¸€ï¼Œä¸“æ³¨æ—¥å¿—æ”¶é›†åŠŸèƒ½ã€‚



##### **âœ…ä¼˜åŠ¿**

logtailå ç”¨æœºå™¨cpuã€å†…å­˜èµ„æºæœ€å°‘ï¼Œç»“åˆé˜¿é‡Œäº‘æ—¥å¿—æœåŠ¡çš„E2Eä½“éªŒè‰¯å¥½ã€‚



##### **âåŠ£åŠ¿**

logtailç›®å‰å¯¹ç‰¹å®šæ—¥å¿—ç±»å‹è§£æçš„æ”¯æŒè¾ƒå¼±ï¼Œåç»­éœ€è¦æŠŠè¿™ä¸€å—è¡¥èµ·æ¥ã€‚



#### **rsyslog**

ç»å¤§å¤šæ•° Linux å‘å¸ƒç‰ˆæœ¬é»˜è®¤çš„ syslog å®ˆæŠ¤è¿›ç¨‹ï¼Œrsyslog å¯ä»¥åšçš„ä¸ä»…ä»…æ˜¯å°†æ—¥å¿—ä» syslog socket è¯»å–å¹¶å†™å…¥ /var/log/messages ã€‚å®ƒå¯ä»¥æå–æ–‡ä»¶ã€è§£æã€ç¼“å†²(ç£ç›˜å’Œå†…å­˜)ä»¥åŠå°†å®ƒä»¬ä¼ è¾“åˆ°å¤šä¸ªç›®çš„åœ°ï¼ŒåŒ…æ‹¬ Elasticsearch ã€‚å¯ä»¥ä»æ­¤å¤„æ‰¾åˆ°å¦‚ä½•å¤„ç† Apache ä»¥åŠç³»ç»Ÿæ—¥å¿—ã€‚

##### âœ…**ä¼˜åŠ¿**

rsyslog æ˜¯ç»æµ‹è¯•è¿‡çš„æœ€å¿«çš„ä¼ è¾“å·¥å…·ã€‚å¦‚æœåªæ˜¯å°†å®ƒä½œä¸ºä¸€ä¸ªç®€å•çš„ router/shipper ä½¿ç”¨ï¼Œå‡ ä¹æ‰€æœ‰çš„æœºå™¨éƒ½ä¼šå—å¸¦å®½çš„é™åˆ¶ï¼Œä½†æ˜¯å®ƒéå¸¸æ“…é•¿å¤„ç†è§£æå¤šä¸ªè§„åˆ™ã€‚å®ƒåŸºäºè¯­æ³•çš„æ¨¡å—(mmnormalize)æ— è®ºè§„åˆ™æ•°ç›®å¦‚ä½•å¢åŠ ï¼Œå®ƒçš„å¤„ç†é€Ÿåº¦å§‹ç»ˆæ˜¯çº¿æ€§å¢é•¿çš„ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå¦‚æœå½“è§„åˆ™åœ¨ 20-30 æ¡æ—¶ï¼Œå¦‚è§£æ Cisco æ—¥å¿—æ—¶ï¼Œå®ƒçš„æ€§èƒ½å¯ä»¥å¤§å¤§è¶…è¿‡åŸºäºæ­£åˆ™å¼è§£æçš„ grok ï¼Œè¾¾åˆ° 100 å€(å½“ç„¶ï¼Œè¿™ä¹Ÿå–å†³äº grok çš„å®ç°ä»¥åŠ liblognorm çš„ç‰ˆæœ¬)ã€‚

å®ƒåŒæ—¶ä¹Ÿæ˜¯æˆ‘ä»¬èƒ½æ‰¾åˆ°çš„æœ€è½»çš„è§£æå™¨ï¼Œå½“ç„¶è¿™ä¹Ÿå–å†³äºæˆ‘ä»¬é…ç½®çš„ç¼“å†²ã€‚

##### â**åŠ£åŠ¿**

rsyslog çš„é…ç½®å·¥ä½œéœ€è¦æ›´å¤§çš„ä»£ä»·(è¿™é‡Œæœ‰ä¸€äº›ä¾‹å­)ï¼Œè¿™è®©ä¸¤ä»¶äº‹æƒ…éå¸¸å›°éš¾ï¼š

æ–‡æ¡£éš¾ä»¥æœç´¢å’Œé˜…è¯»ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å¯¹æœ¯è¯­æ¯”è¾ƒé™Œç”Ÿçš„å¼€å‘è€…ã€‚

5.x ä»¥ä¸Šçš„ç‰ˆæœ¬æ ¼å¼ä¸å¤ªä¸€æ ·(å®ƒæ‰©å±•äº† syslogd çš„é…ç½®æ ¼å¼ï¼ŒåŒæ—¶ä¹Ÿä»ç„¶æ”¯æŒæ—§çš„æ ¼å¼)ï¼Œå°½ç®¡æ–°çš„æ ¼å¼å¯ä»¥å…¼å®¹æ—§æ ¼å¼ï¼Œä½†æ˜¯æ–°çš„ç‰¹æ€§(ä¾‹å¦‚ï¼ŒElasticsearch çš„è¾“å‡º)åªåœ¨æ–°çš„é…ç½®ä¸‹æ‰æœ‰æ•ˆï¼Œç„¶åæ—§çš„æ’ä»¶(ä¾‹å¦‚ï¼ŒPostgres è¾“å‡º)åªåœ¨æ—§æ ¼å¼ä¸‹æ”¯æŒã€‚

å°½ç®¡åœ¨é…ç½®ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œrsyslog æ˜¯å¯é çš„(å®ƒè‡ªèº«ä¹Ÿæä¾›å¤šç§é…ç½®æ–¹å¼ï¼Œæœ€ç»ˆéƒ½å¯ä»¥è·å¾—ç›¸åŒçš„ç»“æœ)ï¼Œå®ƒè¿˜æ˜¯å­˜åœ¨ä¸€äº› bug ã€‚

##### ğŸŒ**å…¸å‹åº”ç”¨åœºæ™¯**

rsyslog é€‚åˆé‚£äº›éå¸¸è½»çš„åº”ç”¨(åº”ç”¨ï¼Œå°VMï¼ŒDockerå®¹å™¨)ã€‚å¦‚æœéœ€è¦åœ¨å¦ä¸€ä¸ªä¼ è¾“å·¥å…·(ä¾‹å¦‚ï¼ŒLogstash)ä¸­è¿›è¡Œå¤„ç†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ TCP è½¬å‘ JSON ï¼Œæˆ–è€…è¿æ¥ Kafka/Redis ç¼“å­˜ã€‚

rsyslog è¿˜é€‚åˆæˆ‘ä»¬å¯¹æ€§èƒ½æœ‰ç€éå¸¸ä¸¥æ ¼çš„è¦æ±‚æ—¶ï¼Œç‰¹åˆ«æ˜¯åœ¨æœ‰å¤šä¸ªè§£æè§„åˆ™æ—¶ã€‚é‚£ä¹ˆè¿™å°±å€¼å¾—ä¸ºä¹‹æŠ•å…¥æ›´å¤šçš„æ—¶é—´ç ”ç©¶å®ƒçš„é…ç½®ã€‚



#### ![kibana](https://gitee.com/JungwooJava/cloudimg/raw/master/kibana.png)Kibana

Kibana æ˜¯ä¸€æ¬¾åŸºäº Apache å¼€æºåè®®ï¼Œä½¿ç”¨ JavaScript è¯­è¨€ç¼–å†™ï¼Œä¸º Elasticsearch æä¾›åˆ†æå’Œå¯è§†	åŒ–çš„ Web å¹³å°ã€‚å®ƒå¯ä»¥åœ¨ Elasticsearch çš„ç´¢å¼•ä¸­æŸ¥æ‰¾ï¼Œäº¤äº’æ•°æ®ï¼Œå¹¶ç”Ÿæˆå„ç§ç»´åº¦çš„è¡¨å›¾ã€‚



##### âœ…ä¼˜åŠ¿

1. èƒ½æ ¹æ®å…³é”®å­—æŸ¥è¯¢æ—¥å¿—è¯¦æƒ…
2. èƒ½ç›‘æ§ç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µ
3. èƒ½è¿›è¡Œç»Ÿè®¡åˆ†æï¼Œæ¯”å¦‚æ¥å£çš„è°ƒç”¨æ¬¡æ•°ã€æ‰§è¡Œæ—¶é—´ã€æˆåŠŸç‡ç­‰
4. èƒ½åŸºäºæ—¥å¿—çš„æ•°æ®æŒ–æ˜
5. æ–¹ä¾¿å¼€å‘äººå‘˜èƒ½éšæ—¶å¯¹æ—¥å¿—è¿›è¡ŒæŸ¥é˜…åˆ†æï¼ˆå¼€å‘ç™»å½•ç”Ÿäº§ç³»ç»Ÿç¯å¢ƒç›´æ¥æŸ¥çœ‹å¾ˆéº»çƒ¦ï¼‰
6. æ—¥å¿—æ•°æ®åˆ†æ•£åœ¨å¤šä¸ªç³»ç»Ÿï¼Œéš¾ä»¥æŸ¥æ‰¾
7. æ—¥å¿—æ•°æ®åˆ·æ–°è¿‡å¿«ï¼Œå®šä½é€Ÿåº¦æ…¢
8. æœ‰æ—¶å€™ä¸€ä¸ªè°ƒç”¨ä¼šæ¶‰åŠå¤šä¸ªç³»ç»Ÿï¼Œå®šä½éš¾åº¦å¤§
9. å¢åŠ æ—¥å¿—æ•°æ®çš„å®æ—¶æ€§



### æ€»ç»“

ELK ï¼ˆElasticSearchã€Logstashã€Kibanaï¼‰ä¸‰æ¬¾è½¯ä»¶ä¹‹é—´äº’ç›¸é…åˆä½¿ç”¨ï¼Œå®Œç¾è¡”æ¥ï¼Œé«˜æ•ˆçš„æ»¡è¶³äº†å¾ˆå¤šåœºåˆçš„åº”ç”¨ï¼Œå¹¶ä¸”è¢«å¾ˆå¤šç”¨æˆ·æ‰€é‡‡çº³ï¼Œè¯¸å¦‚è·¯é€ç¤¾ï¼Œè„¸ä¹¦ï¼ˆFacebookï¼‰ï¼ŒStackOverFlow ç­‰ç­‰ã€‚

åŸºäº ELK stack çš„æ—¥å¿—è§£å†³æ–¹æ¡ˆçš„`ä¼˜åŠ¿`ä¸»è¦ä½“ç°äº

- å¯æ‰©å±•æ€§ï¼šé‡‡ç”¨é«˜å¯æ‰©å±•æ€§çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„è®¾è®¡ï¼Œå¯ä»¥æ”¯æŒæ¯æ—¥ TB çº§åˆ«çš„æ–°å¢æ•°æ®ã€‚
- ä½¿ç”¨ç®€å•ï¼šé€šè¿‡ç”¨æˆ·å›¾å½¢ç•Œé¢å®ç°å„ç§ç»Ÿè®¡åˆ†æåŠŸèƒ½ï¼Œç®€å•æ˜“ç”¨ï¼Œä¸Šæ‰‹å¿«
- å¿«é€Ÿå“åº”ï¼šä»æ—¥å¿—äº§ç”Ÿåˆ°æŸ¥è¯¢å¯è§ï¼Œèƒ½è¾¾åˆ°ç§’çº§å®Œæˆæ•°æ®çš„é‡‡é›†ã€å¤„ç†å’Œæœç´¢ç»Ÿè®¡ã€‚
- ç•Œé¢ç‚«ä¸½ï¼šKibana ç•Œé¢ä¸Šï¼Œåªéœ€è¦ç‚¹å‡»é¼ æ ‡ï¼Œå°±å¯ä»¥å®Œæˆæœç´¢ã€èšåˆåŠŸèƒ½ï¼Œç”Ÿæˆç‚«ä¸½çš„ä»ªè¡¨æ¿

åŸºäºä»¥ä¸Šåˆ†æï¼Œé€‰æ‹©ELKæ–¹æ¡ˆä½œä¸ºå¤§å‹ç³»ç»Ÿçš„æ—¥å¿—æ–¹æ¡ˆã€‚



## 2.2 åŠŸèƒ½æè¿°

`ELK`æ—¥å¿—ä¸­å¿ƒå³Elasticsearchã€Logstashã€Kibanaï¼Œç»„åˆèµ·æ¥æ­å»ºçš„çº¿ä¸Šæ—¥å¿—ç³»ç»Ÿï¼Œæœ¬æ–‡ä¸»è¦ä½¿ç”¨ELKæ¥æ”¶é›†SpringBootåº”ç”¨äº§ç”Ÿçš„æ—¥å¿—ã€‚

![elk+beat](https://gitee.com/JungwooJava/cloudimg/raw/master/elk+beat.png)

- Elasticsearch 

  ç”¨äºå­˜å‚¨æ”¶é›†åˆ°çš„æ—¥å¿—ä¿¡æ¯

- Filebeat

  è½»é‡çº§çš„æ—¥å¿—é‡‡é›†å™¨ï¼Œç”¨äºé‡‡é›†æ—¥å¿—

- Logstash

  åœ¨Logstashä¸­filtersæ˜¯å…¶æ¯”è¾ƒé‡è¦çš„åŠŸèƒ½ï¼Œå®ƒèƒ½å°†æ¯ä¸€å¤©çš„æ—¥å¿—ä¿¡æ¯ï¼ŒæŒ‰ç…§ç‰¹å®šçš„æ ¼å¼è¿›è¡Œè§£æï¼Œåˆ†æˆK-Vçš„æ¨¡å¼ï¼Œè¿™æ ·å°±èƒ½å¾ˆæ–¹ä¾¿çš„å¯¹æ—¥å¿—è¿›è¡Œåˆ†æï¼Œå­˜å‚¨ï¼Œç´¢å¼•

  Logstashä¹Ÿå¯ç”¨äºæ—¥å¿—æ”¶é›†ï¼Œä½†ç”±äºå…¶å†…å­˜æ¶ˆè€—æ¯”è¾ƒå¤§ï¼Œä¸€èˆ¬é‡‡ç”¨Filebeatæ”¶é›†æ—¥å¿—ï¼ŒLogstashè¿‡æ»¤æ—¥å¿—

- Kibana

  é€šè¿‡Webç«¯çš„å¯è§†åŒ–ç•Œé¢æ¥æŸ¥çœ‹æ—¥å¿—ã€‚
  
  

æ—¥å¿—ä¸­å¿ƒçš„æ—¥å¿—ï¼ŒæŒ‰ç…§åœºæ™¯æ¥åˆ’åˆ†ï¼ŒåŒ…å«å››ç±»æ—¥å¿—ï¼š

* è°ƒè¯•æ—¥å¿—

  æœ€å…¨æ—¥å¿—ï¼ŒåŒ…å«äº†åº”ç”¨ä¸­æ‰€æœ‰`DEBUG`çº§åˆ«ä»¥ä¸Šçš„æ—¥å¿—ï¼Œä»…åœ¨å¼€å‘ã€æµ‹è¯•ç¯å¢ƒä¸­å¼€å¯æ”¶é›†ï¼›

* é”™è¯¯æ—¥å¿—

  åªåŒ…å«åº”ç”¨ä¸­æ‰€æœ‰`ERROR`çº§åˆ«çš„æ—¥å¿—ï¼Œæ‰€æœ‰ç¯å¢ƒåªéƒ½å¼€å¯æ”¶é›†ï¼›

* ä¸šåŠ¡æ—¥å¿—

  åœ¨åº”ç”¨`å¯¹åº”åŒ…ä¸‹`æ‰€æœ‰DEBUGçº§åˆ«ä»¥ä¸Šæ‰“å°çš„æ—¥å¿—ï¼Œå¯ç”¨äºæŸ¥çœ‹æˆ‘ä»¬è‡ªå·±åœ¨åº”ç”¨ä¸­æ‰“å°çš„ä¸šåŠ¡æ—¥å¿—ï¼›

* æ“ä½œæ—¥å¿—

  æ¯ä¸ªæ¥å£çš„`è®¿é—®è®°å½•`ï¼Œå¯ä»¥ç”¨æ¥æŸ¥çœ‹æ¥å£æ‰§è¡Œæ•ˆç‡ï¼Œè·å–æ¥å£è®¿é—®å‚æ•°ã€‚




## 2.3 ç³»ç»Ÿæ¶æ„

å¾®æœåŠ¡å¹³å°ç³»ç»Ÿæ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š

![å¾®æœåŠ¡æ¶æ„](https://gitee.com/JungwooJava/cloudimg/raw/master/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png)



æ—¥å¿—å¹³å°æ¶æ„

<img src="https://gitee.com/JungwooJava/cloudimg/raw/master/%E6%97%A5%E5%BF%97%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84.png" alt="æ—¥å¿—å¹³å°æ¶æ„" style="zoom:200%;" />

### æ–¹æ¡ˆä¸€ï¼š**Filebeat+ELK**

ä¸€èˆ¬æƒ…å†µä¸‹å¹³å°å„æœåŠ¡æ¨¡å—çš„æ—¥å¿—éƒ½å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œ [http://Elastic.co](https://link.zhihu.com/?target=http%3A//Elastic.co)å…¬å¸æä¾›äº†Filebeatæ¨¡å—ï¼Œå°†Filebeatéƒ¨ç½²åˆ°ç›¸åº”çš„æœåŠ¡å™¨ä¸Šï¼Œç„¶åè¯»å–æ—¥å¿—æ–‡ä»¶ä¼ ç»™Logstashæˆ–è€…Elasticsearchã€‚ç³»ç»Ÿæ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![Filebeat+ELK](https://gitee.com/JungwooJava/cloudimg/raw/master/Filebeat+ELK.png)



![ELK & EFKéƒ¨ç½²å›¾](https://gitee.com/JungwooJava/cloudimg/raw/master/ELK%20&%20EFK%E9%83%A8%E7%BD%B2%E5%9B%BE.png)

è¿˜æœ‰ä¸€ç§æ–¹æ¡ˆï¼Œå°±æ˜¯ç›´æ¥è®©æœåŠ¡æ¨¡å—æŒ‰ç…§æ ‡å‡†çš„åè®®é€šè¿‡ç½‘ç»œå°†æ—¥å¿—å‘é€ç»™Logstashï¼Œè¿™æ ·å¯ä»¥å‡å°‘æœåŠ¡æ¨¡å—æ‰€åœ¨ä¸»æœºçš„ç£ç›˜IOï¼Œæé«˜æ€§èƒ½ã€‚å¦å¤–ï¼Œä¸éœ€è¦åœ¨æœåŠ¡ä¸»æœºä¸Šå®‰è£…Filebeatæ¨¡å—ï¼Œä½†éœ€è¦ä¿®æ”¹åº”ç”¨ç¨‹åºçš„æ—¥å¿—å¤„ç†æ–¹å¼ã€‚ç¼ºç‚¹æ˜¯ï¼Œéœ€è¦æœåŠ¡å™¨æ€§èƒ½ä½³ï¼Œå› ä¸ºåœ¨æ¯å°æœåŠ¡å™¨ä¸Šå®‰è£…Logstashæ¯”è¾ƒåƒå†…å­˜ã€‚



### æ–¹æ¡ˆäºŒï¼š**EFK**

å³`F`æŒ‡çš„æ˜¯`Fluentd`ï¼Œå®ƒå…·æœ‰Logstashç±»ä¼¼çš„æ—¥å¿—æ”¶é›†åŠŸèƒ½ï¼Œä½†æ˜¯å†…å­˜å ç”¨è¿Logstashçš„ååˆ†ä¹‹ä¸€éƒ½ä¸åˆ°ï¼Œæ€§èƒ½ä¼˜è¶Šã€éå¸¸è½»å·§ã€‚

![EFK](https://gitee.com/JungwooJava/cloudimg/raw/master/ELK%20&%20EFK%E9%83%A8%E7%BD%B2%E5%9B%BE%20(2).png)



### æ–¹æ¡ˆä¸‰ï¼š**flume+kafka+ELK**

![img](https://gitee.com/JungwooJava/cloudimg/raw/master/v2-249ba5f5dac8b2a1fcad55a99e67782a_720w.jpg)



### æ–¹æ¡ˆå››ï¼š**Filebeat+Kafka+ELK**

å¦‚æœéœ€è¦åº”å¯¹é€æ¸å¢å¤§çš„æ—¥å¿—é‡çº§ï¼Œå¯åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºç¼“å†²å±‚

Filebeat  ---> Logstash ---> queue (Redis, Kafka, etc.) ---> Logstash ---> Elasticsearch

Filebeat 5.0æ”¯æŒç›´æ¥è¾“å‡ºæ¶ˆæ¯ç»™kafkaäº†

æ•´ä½“æ¶æ„ä¸»è¦åˆ†ä¸º 4 ä¸ªæ¨¡å—ï¼Œåˆ†åˆ«æä¾›ä¸åŒçš„åŠŸèƒ½

**Filebeat**ï¼šè½»é‡çº§æ•°æ®æ”¶é›†å¼•æ“ã€‚åŸºäºåŸå…ˆ Logstash-fowarder çš„æºç æ”¹é€ å‡ºæ¥ã€‚æ¢å¥è¯è¯´ï¼šFilebeatå°±æ˜¯æ–°ç‰ˆçš„ Logstash-fowarderï¼Œä¹Ÿä¼šæ˜¯ ELK Stack åœ¨ Agent çš„ç¬¬ä¸€é€‰æ‹©ã€‚

**Kafka**: æ•°æ®ç¼“å†²é˜Ÿåˆ—ã€‚ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—è§£è€¦äº†å¤„ç†è¿‡ç¨‹ï¼ŒåŒæ—¶æé«˜äº†å¯æ‰©å±•æ€§ã€‚å…·æœ‰å³°å€¼å¤„ç†èƒ½åŠ›ï¼Œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—èƒ½å¤Ÿä½¿å…³é”®ç»„ä»¶é¡¶ä½çªå‘çš„è®¿é—®å‹åŠ›ï¼Œè€Œä¸ä¼šå› ä¸ºçªå‘çš„è¶…è´Ÿè·çš„è¯·æ±‚è€Œå®Œå…¨å´©æºƒã€‚

**Logstash** ï¼šæ•°æ®æ”¶é›†å¤„ç†å¼•æ“ã€‚æ”¯æŒåŠ¨æ€çš„ä»å„ç§æ•°æ®æºæœé›†æ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤ã€åˆ†æã€ä¸°å¯Œã€ç»Ÿä¸€æ ¼å¼ç­‰æ“ä½œï¼Œç„¶åå­˜å‚¨ä»¥ä¾›åç»­ä½¿ç”¨ã€‚

**Elasticsearch** ï¼šåˆ†å¸ƒå¼æœç´¢å¼•æ“ã€‚å…·æœ‰é«˜å¯ä¼¸ç¼©ã€é«˜å¯é ã€æ˜“ç®¡ç†ç­‰ç‰¹ç‚¹ã€‚å¯ä»¥ç”¨äºå…¨æ–‡æ£€ç´¢ã€ç»“æ„åŒ–æ£€ç´¢å’Œåˆ†æï¼Œå¹¶èƒ½å°†è¿™ä¸‰è€…ç»“åˆèµ·æ¥ã€‚Elasticsearch åŸºäº Lucene å¼€å‘ï¼Œç°åœ¨ä½¿ç”¨æœ€å¹¿çš„å¼€æºæœç´¢å¼•æ“ä¹‹ä¸€ï¼ŒWikipedia ã€StackOverflowã€Github ç­‰éƒ½åŸºäºå®ƒæ¥æ„å»ºè‡ªå·±çš„æœç´¢å¼•æ“ã€‚

**Kibana** ï¼šå¯è§†åŒ–åŒ–å¹³å°ã€‚å®ƒèƒ½å¤Ÿæœç´¢ã€å±•ç¤ºå­˜å‚¨åœ¨ Elasticsearch ä¸­ç´¢å¼•æ•°æ®ã€‚ä½¿ç”¨å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿çš„ç”¨å›¾è¡¨ã€è¡¨æ ¼ã€åœ°å›¾å±•ç¤ºå’Œåˆ†ææ•°æ®ã€‚

![äº¿çº§ ELK æ—¥å¿—å¹³å°æ„å»ºå®è·µ](https://s4.51cto.com/images/blog/201805/16/fdfd8706744a67866b2e34368da3f2f2.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_100,g_se,x_10,y_10,shadow_90,type_ZmFuZ3poZW5naGVpdGk=)





![beat+ka+elk (2)](https://gitee.com/JungwooJava/cloudimg/raw/master/beat+ka+elk%20(2).png)



<img src="https://gitee.com/JungwooJava/cloudimg/raw/master/beat+ka+elk.png" alt="beat+ka+elk" style="zoom:125%;" />



## 2.4 æŠ€æœ¯é€‰å‹

| è½¯ä»¶                | æè¿°               | å®˜ç½‘                                     |
| ------------------- | ------------------ | ---------------------------------------- |
| ElasticSearch-6.1.0 | æœç´¢å¼•æ“           | https://github.com/elastic/elasticsearch |
| SpringBoot          | SpringBoot         | https://spring.io/projects/spring-boot   |
| Kibana-6.1.0        | æ—¥å¿—å¯è§†åŒ–æŸ¥çœ‹å·¥å…· | https://github.com/elastic/kibana        |
| Filebeat-6.1.0      | æ—¥å¿—æ”¶é›†å·¥å…·       | https://github.com/elastic/filebeat      |
| Logstash-6.1.0      | æ—¥å¿—æ”¶é›†å·¥å…·       | https://github.com/elastic/logstash      |





## 2.5 å¤„ç†æµç¨‹

- Filebeat ä»å„ä¸ªèŠ‚ç‚¹ä¸­æå–æ—¥å¿—ä¿¡æ¯
- Logstash è¿‡æ»¤å¤„ç†æ—¥å¿—ä¿¡æ¯
- Logstash å°†æ—¥å¿—è½¬å‘åˆ° Elasticsearch è¿›è¡Œç´¢å¼•å’Œä¿å­˜
- Kibana è´Ÿè´£åˆ†æå’Œå¯è§†åŒ–æ—¥å¿—ä¿¡æ¯

![ELK & EFKéƒ¨ç½²å›¾](C:\Users\é™ˆæ¬£\Documents\è°ƒç ”\ELKæ—¥å¿—ç³»ç»Ÿ\ç´ æ\ELK & EFKéƒ¨ç½²å›¾.png)



## 2.6 æ³¨æ„äº‹é¡¹

* ESå†…å­˜æ ˆå¤§å°ä¸è¶…è¿‡50%ç³»ç»Ÿå†…å­˜ï¼Œå¹¶ä¸”ä¸è¶…è¿‡32G

* Index.number_of_replicas

  å‡å°‘Elasticsearchçš„indexæ—¥å¿—æ”¶é›†æ—¶çš„å¤åˆ¶æ•°ï¼Œä»¥å‡å°‘IOï¼Œå¦‚æœåæœŸéœ€è¦å­˜å‚¨å¤‡ä»½ï¼Œåˆ™å†å°†å¤åˆ¶æ•°å¢å¤§ï¼ŒElasticsearchä¼šè‡ªåŠ¨å°†æ•°æ®è¿›è¡Œé‡æ–°æ•´ç†å¤‡ä»½ã€‚

* Index.refresh_interval

  æ•°æ®ä»ç¼“å­˜åˆ·æ–°åˆ°ç£ç›˜çš„é—´éš”ï¼Œé—´éš”è¶Šå¤§,ç£ç›˜IOè¶Šå°‘ã€‚

*  Index.translog.durability

  é»˜è®¤æƒ…å†µä¸‹ï¼ŒElasticsearch æ¯5 ç§’ï¼Œæˆ–æ¯æ¬¡è¯·æ±‚æ“ä½œç»“æŸå‰ï¼Œä¼šå¼ºåˆ¶åˆ·æ–°translog æ—¥å¿—åˆ°ç£ç›˜ä¸Šã€‚åè€…æ˜¯Elasticsearch 2.0 æ–°åŠ å…¥çš„ç‰¹æ€§ã€‚ä¸ºäº†ä¿è¯ä¸ä¸¢æ•°æ®ï¼Œæ¯æ¬¡indexã€bulkã€deleteã€update å®Œæˆçš„æ—¶å€™ï¼Œä¸€å®šè§¦å‘åˆ·æ–°translog åˆ°ç£ç›˜ä¸Šï¼Œæ‰ç»™è¯·æ±‚è¿”å›200 OKã€‚è¿™ä¸ªæ”¹å˜åœ¨æé«˜æ•°æ®å®‰å…¨æ€§çš„åŒæ—¶å½“ç„¶ä¹Ÿé™ä½äº†ä¸€ç‚¹æ€§èƒ½ã€‚å¦‚æœä½ ä¸åœ¨æ„è¿™ç‚¹å¯èƒ½æ€§ï¼Œè¿˜æ˜¯å¸Œæœ›æ€§èƒ½ä¼˜å…ˆï¼Œå¯ä»¥åœ¨index template é‡Œè®¾ç½®å¦‚ä¸‹å‚æ•°ï¼š"index.translog.durability" : "async"

* index.merge.scheduler.max_thread_count

  mergeçº¿ç¨‹çš„æ•°é‡ï¼Œçº¿ç¨‹æ•°è¶Šå°‘ï¼Œç£ç›˜IOè¶Šå°‘ã€‚è®¾ç½®ä¸º1å³å¯ã€‚

* ç¡¬ä»¶æ–¹é¢å°½å¯èƒ½çš„ï¼š

  â˜… åº”ç”¨SSDï¼šæé«˜I/Oåå

  â˜… å¢å¤§CPUï¼Œå†…å­˜ï¼šæé«˜æŸ¥è¯¢æ€§èƒ½

* æ‰€æœ‰æœºå™¨å…³é—­é˜²ç«å¢™ï¼Œselinux

  



# 3 æ¨¡å—è®¾è®¡

## 3.1 é€šè¿‡æ—¥å¿—ç»„ä»¶æ¥æ”¶é›†

è¿™é‡Œæ˜¯æŒ‡é€šè¿‡logbackã€log4jç­‰æ—¥å¿—ç»„ä»¶æ¥è¾“å‡ºæ–‡ä»¶ï¼Œç„¶åå†é€šè¿‡æ–‡ä»¶è¾“å‡ºåˆ° Logstashã€Kibana ç­‰æ—¥å¿—ç»„ä»¶ä¸­ï¼Œé€šè¿‡è¿™äº›æ—¥å¿—ç»„ä»¶æ¥è¿›è¡Œå¯è§†åŒ–ç»Ÿè®¡ä¸åˆ†æï¼Œè¿™é‡Œéœ€è¦ç»Ÿä¸€å…³é”®æ—¥å¿—è¾“å‡ºæ ¼å¼æ–¹ä¾¿æ—¥åç»Ÿè®¡æœç´¢ã€‚

ä¼˜ç‚¹

- æ“ä½œç®€å•ï¼Œæ”¶é›†æ–¹ä¾¿
- å‡å°‘ä¸šåŠ¡ä¾èµ–
- ç²’åº¦ç»†



ç¼ºç‚¹

- ä¾èµ–äº Logstashã€Kibana
- åªèƒ½æ»¡è¶³ç®€å•çš„æ—¥å¿—æ“ä½œï¼Œè¯¦ç»†ç‚¹æˆ–è€…ä¸ªæ€§åŒ–éœ€æ±‚æ“ä½œèµ·æ¥æ¯”è¾ƒå¤æ‚



ç¤ºä¾‹

* å¼•å…¥ logstash-logbackæ”¯æŒåŒ…

  ````xml
  <dependency>
      <groupId>net.logstash.logback</groupId>
      <artifactId>logstash-logback-encoder</artifactId>
      <version>6.6</version>
  </dependency>
  <!-- Your project must also directly depend on either logback-classic or logback-access.  For example: -->
  <dependency>
      <groupId>ch.qos.logback</groupId>
      <artifactId>logback-classic</artifactId>
      <version>1.2.3</version>
  </dependency>
  ````

* Java ç‰ˆæœ¬è¦æ±‚

  | logstash-logback-encoder | æœ€å°Java ç‰ˆæœ¬æ”¯æŒ |
  | :----------------------- | ----------------- |
  | >= 6.0                   | 1.8               |
  | 5.x                      | 1.7               |
  | <= 4.x                   | 1.6               |

  

* é€šè¿‡æ·»åŠ é…ç½®æ–‡ä»¶logback-spring.xmlè®©logbackçš„æ—¥å¿—è¾“å‡ºåˆ°logstash

```xml
<!--åº”ç”¨åç§°-->   
<property name="APP_NAME" value="act-log"/>

<!--æ—¥å¿—æ–‡ä»¶ä¿å­˜è·¯å¾„-->
<property name="LOG_FILE_PATH" 	 value="${LOG_FILE:-${LOG_PATH:-${LOG_TEMP:-${java.io.tmpdir:-/tmp}}}/logs}" />

<contextName>${APP_NAME}</contextName>

<!--æ¯å¤©è®°å½•æ—¥å¿—åˆ°æ–‡ä»¶appender-->    
<appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
	<rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">         		<!-- æŒ‰å¤©è½®è½¬ -->
    	<fileNamePattern>${LOG_FILE_PATH}/${APP_NAME}-%d{yyyy-MM-dd}.log</fileNamePattern>
         <!--è®¾ç½®æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œè¶…è¿‡å°±é‡æ–°ç”Ÿæˆæ–‡ä»¶ï¼Œé»˜è®¤10M-->
         <maxFileSize>${LOG_FILE_MAX_SIZE:-10MB}</maxFileSize>
          <!-- ä¿å­˜ 30 å¤©çš„å†å²è®°å½•  æœ€å¤§å¤§å°ä¸º 3GB-->
		<maxHistory>30</maxHistory>
        <totalSizeCap>3GB</totalSizeCap>
	</rollingPolicy>
	<encoder>      
		<pattern>${FILE_LOG_PATTERN}</pattern>       
    </encoder>
</appender>
  
<!--è¾“å‡ºåˆ°logstashçš„appender-->
<appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
	<!--å¯ä»¥è®¿é—®çš„logstashæ—¥å¿—æ”¶é›†ç«¯å£-->
	<destination>172.31.133.12:4560</destination>
	<encoder charset="UTF-8" class="net.logstash.logback.encoder.LogstashEncoder"/>
</appender>

```

* Logstashé…ç½®

  ```php
  input {
    tcp {
      mode => "server"
      host => "0.0.0.0"
      port => 4560
      codec => json_lines
      type => "debug"
    }
    tcp {
      mode => "server"
      host => "0.0.0.0"
      port => 4561
      codec => json_lines
      type => "error"
    }
    tcp {
      mode => "server"
      host => "0.0.0.0"
      port => 4562
      codec => json_lines
      type => "business"
    }
    tcp {
      mode => "server"
      host => "0.0.0.0"
      port => 4563
      codec => json_lines
      type => "record"
    }
  }
  filter{
    if [type] == "record" {
      mutate {
        remove_field => "port"
        remove_field => "host"
        remove_field => "@version"
      }
      json {
        source => "message"
        remove_field => ["message"]
      }
    }
  }
  output {
    elasticsearch {
      hosts => ["es:19200"]
      action => "index"
      codec => json
      index => "act-log-%{type}-%{+YYYY.MM.dd}"
      template_name => "act-log"
    }
  }
  ```
  
* é…ç½®è¦ç‚¹

  - inputï¼šä½¿ç”¨ä¸åŒç«¯å£æ”¶é›†ä¸åŒç±»å‹çš„æ—¥å¿—ï¼Œä»4560~4563å¼€å¯å››ä¸ªç«¯å£ï¼›
  - filterï¼šå¯¹äºè®°å½•ç±»å‹çš„æ—¥å¿—ï¼Œç›´æ¥å°†JSONæ ¼å¼çš„messageè½¬åŒ–åˆ°sourceä¸­å»ï¼Œä¾¿äºæœç´¢æŸ¥çœ‹ï¼›
  - outputï¼šæŒ‰ç±»å‹ã€æ—¶é—´è‡ªå®šä¹‰ç´¢å¼•æ ¼å¼ã€‚



## 3.2 SpringBootä½¿ç”¨AOPæ¥æ‹¦æˆªcontroller

é€šè¿‡åœ¨controllerå±‚å»ºä¸€ä¸ªåˆ‡é¢æ¥å®ç°æ¥å£è®¿é—®çš„ç»Ÿä¸€æ—¥å¿—è®°å½•ï¼Œé€šè¿‡controllerä¸­çš„æ–¹æ³•åæ˜¯å¦åŒ…å«insertã€updateã€deleteç­‰å…³é”®å­—æ¥è®°å½•ä¸šåŠ¡æ—¥å¿—ï¼Œæ—¥å¿—ç›´æ¥è¾“å…¥åˆ°ESã€‚



ä¼˜ç‚¹

- æ“ä½œç®€å•ï¼Œæ”¶é›†æ–¹ä¾¿



ç¼ºç‚¹

- åªèƒ½è®°å½•ç®€å•æ—¥å¿—
- ä¸åŒçš„äººå‘½åä¹ æƒ¯ä¸ä¸€æ ·ï¼Œæ—¥å¿—å¯èƒ½ä¸å‡†ç¡®



ç¤ºä¾‹

> å®šä¹‰æ—¥å¿—åˆ‡é¢ï¼Œåœ¨ç¯ç»•é€šçŸ¥ä¸­è·å–æ—¥å¿—éœ€è¦çš„ä¿¡æ¯ï¼Œå¹¶åº”ç”¨åˆ°controllerå±‚ä¸­æ‰€æœ‰çš„publicæ–¹æ³•ä¸­å»

```java
package com.macro.mall.tiny.component;

import cn.hutool.core.util.StrUtil;
import cn.hutool.core.util.URLUtil;
import cn.hutool.json.JSONUtil;
import com.macro.mall.tiny.dto.WebLog;
import io.swagger.annotations.ApiOperation;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.Signature;
import org.aspectj.lang.annotation.*;
import org.aspectj.lang.reflect.MethodSignature;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.lang.reflect.Method;
import java.lang.reflect.Parameter;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * ç»Ÿä¸€æ—¥å¿—å¤„ç†åˆ‡é¢
 */
@Aspect
@Component
@Order(1)
public class WebLogAspect {
    private static final Logger LOGGER = LoggerFactory.getLogger(WebLogAspect.class);

    @Pointcut("execution(public * com.act.idc.controller.*.*(..))")
    public void webLog() {
    }

    @Before("webLog()")
    public void doBefore(JoinPoint joinPoint) throws Throwable {
    }

    @AfterReturning(value = "webLog()", returning = "ret")
    public void doAfterReturning(Object ret) throws Throwable {
    }

    @Around("webLog()")
    public Object doAround(ProceedingJoinPoint joinPoint) throws Throwable {
        long startTime = System.currentTimeMillis();
        //è·å–å½“å‰è¯·æ±‚å¯¹è±¡
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();
        //è®°å½•è¯·æ±‚ä¿¡æ¯
        WebLog webLog = new WebLog();
        Object result = joinPoint.proceed();
        Signature signature = joinPoint.getSignature();
        MethodSignature methodSignature = (MethodSignature) signature;
        Method method = methodSignature.getMethod();
        if (method.isAnnotationPresent(ApiOperation.class)) {
            ApiOperation apiOperation = method.getAnnotation(ApiOperation.class);
            webLog.setDescription(apiOperation.value());
        }
        long endTime = System.currentTimeMillis();
        String urlStr = request.getRequestURL().toString();
        webLog.setBasePath(StrUtil.removeSuffix(urlStr, URLUtil.url(urlStr).getPath()));
        webLog.setIp(request.getRemoteUser());
        webLog.setMethod(request.getMethod());
        webLog.setParameter(getParameter(method, joinPoint.getArgs()));
        webLog.setResult(result);
        webLog.setSpendTime((int) (endTime - startTime));
        webLog.setStartTime(startTime);
        webLog.setUri(request.getRequestURI());
        webLog.setUrl(request.getRequestURL().toString());
        LOGGER.info("{}", JSONUtil.parse(webLog));
        return result;
    }

    /**
     * æ ¹æ®æ–¹æ³•å’Œä¼ å…¥çš„å‚æ•°è·å–è¯·æ±‚å‚æ•°
     */
    private Object getParameter(Method method, Object[] args) {
        List<Object> argList = new ArrayList<>();
        Parameter[] parameters = method.getParameters();
        for (int i = 0; i < parameters.length; i++) {
            //å°†RequestBodyæ³¨è§£ä¿®é¥°çš„å‚æ•°ä½œä¸ºè¯·æ±‚å‚æ•°
            RequestBody requestBody = parameters[i].getAnnotation(RequestBody.class);
            if (requestBody != null) {
                argList.add(args[i]);
            }
            //å°†RequestParamæ³¨è§£ä¿®é¥°çš„å‚æ•°ä½œä¸ºè¯·æ±‚å‚æ•°
            RequestParam requestParam = parameters[i].getAnnotation(RequestParam.class);
            if (requestParam != null) {
                Map<String, Object> map = new HashMap<>();
                String key = parameters[i].getName();
                if (!StringUtils.isEmpty(requestParam.value())) {
                    key = requestParam.value();
                }
                map.put(key, args[i]);
                argList.add(map);
            }
        }
        if (argList.size() == 0) {
            return null;
        } else if (argList.size() == 1) {
            return argList.get(0);
        } else {
            return argList;
        }
    }
}

```



## 3.3 ä½¿ç”¨æ³¨è§£æ¥ï¼Œè¿›è¡Œç¨å¾®ç²¾å‡†çš„ä¸šåŠ¡æ—¥å¿—è®°å½•

ä¼˜ç‚¹

è¿™ä¸ªæ–¹æ¡ˆç²’åº¦å¯å¤§å¯å°ï¼Œä»£ç ä¾µå…¥æ€§ä¹Ÿæ¯”è¾ƒå°ï¼Œå¯æ“ä½œæ€§æ¯”è¾ƒå¼ºï¼Œå¦‚æœéœ€è¦è·å–å‚æ•°ä¿¡æ¯æˆ–è€…è¿”å›å€¼ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡æ³¨è§£é…ç½®è·å–åˆ°ï¼Œå¯ä»¥é›†åˆfastjsonä¸­çš„jpathæ¥è·å–å‚æ•°å€¼



ç¼ºç‚¹

å…·æœ‰å°‘é‡çš„ä»£ç ä¾µå…¥æ€§ï¼ˆæ³¨è§£ï¼‰



å®é™…å¼€å‘ç»éªŒ

å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¾€å¾€æ­¤æ“ä½œæ—¥å¿—æ³¨è§£ä¸­çš„æ–‡å­—æè¿°ä¸swagger Apiä¸­çš„æœ‰æ‰€é‡å¤ï¼Œå¯ç›´æ¥é‡‡å–æ–¹å¼äºŒç»Ÿä¸€æ‹¦æˆªï¼Œè·å–Swagger Apiä¸­çš„æ³¨è§£æè¿°å³å¯ã€‚



ç¤ºä¾‹

 ```java
/**
 *
 * <p>Title: OperateLogInterceptor
 * <p>Description: æ“ä½œè®°å½•æ‹¦æˆªå™¨
 */
@Component
@Aspect
@Log4j2
public class OperateLogInterceptor {
    /** å­—æ®µç¼“å­˜ */
    private static Cache<Class<?>, Field[]> FIELDS_CACHE= CacheBuilder.newBuilder().build();
    /**
     * æ³¨è§£å†…å®¹ç¼“å­˜
     */
    private static Cache<Class<?>, Field> ANNOTATION_FIELDS_CACHE= CacheBuilder.newBuilder().build();

    /**
     * å®šä¹‰ç»‡å…¥åˆ‡é¢çš„èŒƒå›´ï¼Œç›®å‰åªä¼šç»‡å…¥controllerçš„è¯·æ±‚éƒ¨åˆ†
     */
    @Pointcut("execution(* com.act..*.controller..*.*(..)) && @annotation(com.act.util.operatelog.OperateLog)")
    private void controllerAspect() {}// å®šä¹‰ä¸€ä¸ªåˆ‡å…¥ç‚¹

    /**
     * åœ¨è¯·æ±‚å®Œæ¯•åï¼Œä¿å­˜æ—¥å¿—è¡¨
     * @param pjd åˆ‡å…¥ç‚¹
     * @throws Throwable æ“ä½œæ—¥å¿—å¼‚å¸¸
     */
    @Around("controllerAspect()")
    public Object doAroundMethod(ProceedingJoinPoint pjd) throws Throwable {
        String opDesc = getOpDesc(pjd);
        // å…¶ä¸­æŸ¥è¯¢ç³»åˆ—çš„æ—¥å¿—è®°å½•æ ¹æ®å¼€å…³æ§åˆ¶æ˜¯å¦å…¥åº“ï¼Œé»˜è®¤ä¸éœ€è¦å…¥åº“
        if (OperateLogConstant.PAGING.equals(opDesc) ||
                OperateLogConstant.INIT.equals(opDesc) ||
                OperateLogConstant.INIT_EDIT.equals(opDesc) ||
                OperateLogConstant.VIEW.equals(opDesc) ){
            String flag = "0";
			/*if (flag.equals(EhcacheUtil.getConfigByConfigId(ConfigConstant.OPERATE_LOG_VIEW_SWITCH))){
				return pjd.proceed();
			}*/
        }
        HttpServletRequest request = getHttpServletRequest();
        String userId = BaseContextHandler.getUserID()!=null?BaseContextHandler.getUserID():"auto";
        String ip = IpUtil.getClientIP(request);
        // è·å–è¯·æ±‚å‚æ•°
        boolean argInsert = false;
        Object[] params = pjd.getArgs();
        StringBuilder paramStr = new StringBuilder();
        for (Object param : params) {
            if (param instanceof HttpServletRequest || param instanceof HttpServletResponse || param instanceof HttpSession){
                continue;
            }
            try {
                paramStr.append(JSONUtil.toJsonStr(param)).append(" ");
                if(paramStr.length()>=1024){
                    break;
                }
            } catch (Exception e) {
                log.error("è·å–å‚æ•°å¼‚å¸¸",e);
            }
        }
        Object returnVal = null;
        TOperateLog operateLog = null;
        Long startTime=System.currentTimeMillis();
        try {
            operateLog = getBeforeLog(pjd,userId,ip,paramStr.toString(),argInsert);
            returnVal = pjd.proceed();
            operateLog = getAfterLog(pjd, operateLog, returnVal);
        } catch (Throwable ex) {
            operateLog = getExceptionLog(pjd, operateLog, ex);
            log.error(ex.getMessage());
            throw ex;
        } finally {
            if (operateLog != null) {
                // æ‰§è¡Œæ—¶é—´
                operateLog.setOpExecTimeMillis((int) (System.currentTimeMillis() - startTime));
                operateLog.insert();
            }
        }
        return returnVal;
    }

    /**
     * <p>title: getBeforeLog
     * <p>Description:æ“ä½œæ–¹æ³•å‰è·å–æ—¥å¿—ä¿¡æ¯ï¼Œä¸»è¦æ˜¯æ³¨è§£ç±»å’ŒIPç­‰
     * @param pjd åˆ‡é¢æ“ä½œç±»
     * @return æ—¥å¿—å®ä½“å¯¹è±¡
     */
    private TOperateLog getBeforeLog(JoinPoint pjd, String userId, String ip, String paramStr, boolean 		 argInsert) {
        TOperateLog operateLog = new TOperateLog();
        // æ“ä½œäºº
        operateLog.setOpOperater(userId==null?"ç³»ç»Ÿ":userId);
        // æ“ä½œæ—¶é—´
        operateLog.setOpTime(LocalDateTime.now());
        //é»˜è®¤å†™çš„å€¼ï¼Œå¯¹äºæ“ä½œç±»å‹ï¼Œæ‰“ç®—åºŸé™¤
        operateLog.setOpType("01");
        // æ“ä½œæè¿°
        operateLog.setOpDesc(getOpDesc(pjd));
        // æ“ä½œç»“æœ
        operateLog.setOpResult(true);
        // æ“ä½œIP
        operateLog.setOpIp(ip);
        // æ“ä½œå¯¹è±¡
        operateLog.setOpObject(getOpObject(pjd)+(argInsert?"-æ–°å¢":""));
        // æ“ä½œå‚æ•°
        operateLog.setOpParams(paramStr.length()>=1024? paramStr.substring(0,1024): paramStr);
        return operateLog;
    }

    /**
     * è®¾ç½®æ‰§è¡Œå®Œæˆåå¯¹åº”çš„æ—¥å¿—å†…å®¹
     *
     * @param pjp
     * @param operateLog
     * @param returnVal
     * @return
     */
    public TOperateLog getAfterLog(ProceedingJoinPoint pjp, TOperateLog operateLog, Object returnVal) {
        if (returnVal == null || !(returnVal instanceof RestResponse)) {
            operateLog.setOpResponse("");
            operateLog.setOpResult(true);
        } else {
            RestResponse rs = (RestResponse) returnVal;
            if(rs.getCode()!=200){
                operateLog.setOpResult(false);
            }
            operateLog.setOpResponse(rs.getMessage());
        }
        operateLog.setOpResponse(getRightLengthString(operateLog.getOpResponse(),1024));
        return operateLog;
    }


    /**
     * è®¾ç½®å¼‚å¸¸å‘ç”Ÿæ—¶å¯¹åº”çš„æ—¥å¿—å†…å®¹
     *
     * @param pjp
     * @param operateLog
     * @param ex
     * @return
     */
    public TOperateLog getExceptionLog(ProceedingJoinPoint pjp, TOperateLog operateLog, Throwable ex) {
        operateLog.setOpResult(false);
        operateLog.setOpResponse(getRightLengthString(ex.getMessage(), 500));
        return operateLog;
    }

    /**
     * æ ¹æ®ç»™å®šçš„é•¿åº¦æˆªå–æ”¯ä»˜æŸ¥
     *
     * @param str
     * @param length
     * @return
     */
    private String getRightLengthString(String str, int length) {
        return StringUtils.hasLength(str) && str.length() > length ? str.substring(0, length) : str;
    }

    /**
     * <p>Title: getHttpServletRequest
     * <p>Description: è·å–request
     * @author FMJ
     * @date 2018/3/19 8:44
     * @return requestå¯¹è±¡
     */
    private HttpServletRequest getHttpServletRequest() {
        RequestAttributes ra = RequestContextHolder.getRequestAttributes();
        ServletRequestAttributes sra = (ServletRequestAttributes) ra;
        return sra.getRequest();
    }

    /**
     * <p>title: getAnnotation
     * <p>Description:è·å–å‚æ•°æ³¨è§£
     * @param joinPoint åˆ‡é¢
     * @return æ³¨è§£
     */
    private OperateLog getAnnotation(JoinPoint joinPoint){
        try {
            String targetName = joinPoint.getTarget().getClass().getName();
            String methodName = joinPoint.getSignature().getName();
            Object[] arguments = joinPoint.getArgs();
            Class targetClass = Class.forName(targetName);
            Method[] methods = targetClass.getMethods();

            for (Method method : methods) {
                if (method.getName().equals(methodName)) {
                    Class[] clazzs = method.getParameterTypes();
                    if (clazzs.length == arguments.length) {
                        return method.getAnnotation(OperateLog.class);
                    }
                }
            }
        } catch (ClassNotFoundException e) {
            log.error("è·å–æ³¨è§£å¼‚å¸¸ï¼š",e);
        }
        return null;
    }

    /**
     * <p>Title: getOpDesc
     * <p>Description: è·å–æ“ä½œæè¿°
     * @param joinPoint åˆ‡å…¥ç‚¹
     * @return å‚æ•°
     * @throws Exception å¼‚å¸¸
     */
    private String getOpDesc(JoinPoint joinPoint) {
        String opDesc = "";
        OperateLog operateLog=getAnnotation(joinPoint);
        if(operateLog!=null){
            opDesc=operateLog.opDesc();
        }
        return opDesc;
    }

    /**
     * <p>Title: getOpObject
     * <p>Description: æ“ä½œå¯¹è±¡
     * @param joinPoint åˆ‡å…¥ç‚¹
     * @return æ“ä½œå¯¹è±¡
     */
    private String getOpObject(JoinPoint joinPoint) {
        String opObject = "";
        OperateLog operateLog=getAnnotation(joinPoint);
        if(operateLog!=null){
            opObject=operateLog.opObject();
        }
        return opObject;
    }

    private Field[] getFileds(Class<?> beanClass){
        Field[] allFields = FIELDS_CACHE.getIfPresent(beanClass);
        if (null != allFields) {
            return allFields;
        }
        Field[] fields = beanClass.getSuperclass().getDeclaredFields();
        FIELDS_CACHE.put(beanClass,fields);
        return fields;
    }

    private Field getAnnotationField(Class<?> beanClass,Class annotationCls){
        Field ifPresent = ANNOTATION_FIELDS_CACHE.getIfPresent(beanClass);
        if(ifPresent!=null){
            return ifPresent;
        }
        Field[] fields = getFileds(beanClass);
        for(Field field:fields){
            field.setAccessible(true);
            Annotation fieldAnnotation = field.getAnnotation(annotationCls);
            if(fieldAnnotation!=null){
                ANNOTATION_FIELDS_CACHE.put(beanClass,field);
                return field;
            }
        }
        return null;
    }
}
 ```



```java
@OperateLog(opObject = OperateLogConstant.SAVE_OR_UPDATE, opDesc = "ä¿å­˜ä¿®æ”¹ä¿¡æ¯")
```



## 3.4 é’ˆå¯¹å¤æ‚åœºæ™¯æˆ–è€…å®¡è®¡éœ€æ±‚æ‰‹åŠ¨è®°å½•ï¼Œä¾µå…¥æ€§å¼º

å¦‚æœæœ‰äº›ä¸šåŠ¡å…¬ç”¨äº†æ–¹æ³•ï¼Œéœ€è¦æ›´å°çš„ç²’åº¦ï¼Œæˆ–è€…éœ€è¦è®°å½•ä¸šåŠ¡æ•°æ®å˜æ›´è®°å½•ï¼Œè¿™æ—¶å°±åªèƒ½é€‰æ‹©ä¾µå…¥å¼è¾ƒå¼ºçš„æ–¹å¼æ¥è®°å½•æ—¥å¿—äº†ï¼Œç›´æ¥åœ¨ä¸šåŠ¡ä»£ç ä¸­è®°å½•æ—¥å¿—

```java
logClient.logObject(LogObjectType.XXX,id,UserContext.getUserName(),"ç¼–è¾‘xxx","xxxå˜æ›´ä¸ºxxxxx");
```



## 3.5 è®°å½•Sqlæ—¥å¿—

åˆ™å¯ä»¥ä½¿ç”¨Mybatisæ‹¦æˆªå™¨æ¥è¿›è¡Œï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨Mybatisï¼Œåˆ™å¯ä»¥åšä¸€ä¸ªé€šç”¨çš„Preparestatementä»¥åŠstatementä»£ç†ã€‚

å½“ç„¶ç°åœ¨å·²ç»æœ‰å¾ˆå¤šç›‘æ§ç»„ä»¶å¯ä»¥æ»¡è¶³è¿™ä¸ªéœ€æ±‚ï¼Œæ¯”å¦‚è¯´jeagerã€javamelodyã€druidç­‰

ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé‡‡ç”¨å¤šç§æ–¹å¼æ¥è®°å½•ä¸šåŠ¡æ—¥å¿—ï¼Œè¿™ä¸ªéƒ½æ˜¯æ ¹æ®å…·ä½“éœ€æ±‚æ¥è¿›è¡Œè¯„ä¼°ç”¨å“ªå‡ ç§æ–¹å¼å¯ä»¥æ›´å¥½çš„è¾¾åˆ°äº§å“éœ€æ±‚

## 3.6 éè§„èŒƒçš„æ—¥å¿—é‡‡é›†å±•ç¤ºæµç¨‹

éœ€è¦ç»™å‡ºéè§„èŒƒæ—¥å¿—çš„å®ä¾‹ï¼Œå®šåˆ¶åŒ–å¼€å‘é…ç½®ï¼Œè½¬åŒ–ä¸ºæ ‡å‡†æ—¥å¿—ã€‚



# 4 æ—¥å¿—æ•°æ®è¾“å…¥æº

## 4.1 æŒ‰ç…§åœºæ™¯åˆ’åˆ†

* è°ƒè¯•æ—¥å¿—

  æœ€å…¨æ—¥å¿—ï¼ŒåŒ…å«äº†åº”ç”¨ä¸­æ‰€æœ‰`DEBUG`çº§åˆ«ä»¥ä¸Šçš„æ—¥å¿—ï¼Œä»…åœ¨å¼€å‘ã€æµ‹è¯•ç¯å¢ƒä¸­å¼€å¯æ”¶é›†ï¼›

* é”™è¯¯æ—¥å¿—

  åªåŒ…å«åº”ç”¨ä¸­æ‰€æœ‰`ERROR`çº§åˆ«çš„æ—¥å¿—ï¼Œæ‰€æœ‰ç¯å¢ƒåªéƒ½å¼€å¯æ”¶é›†ï¼›

* ä¸šåŠ¡æ—¥å¿—

  åœ¨åº”ç”¨`å¯¹åº”åŒ…ä¸‹`æ‰€æœ‰DEBUGçº§åˆ«ä»¥ä¸Šæ‰“å°çš„æ—¥å¿—ï¼Œå¯ç”¨äºæŸ¥çœ‹æˆ‘ä»¬è‡ªå·±åœ¨åº”ç”¨ä¸­æ‰“å°çš„ä¸šåŠ¡æ—¥å¿—ï¼›

* æ“ä½œæ—¥å¿—

  æ¯ä¸ªæ¥å£çš„`è®¿é—®è®°å½•`ï¼Œå¯ä»¥ç”¨æ¥æŸ¥çœ‹æ¥å£æ‰§è¡Œæ•ˆç‡ï¼Œè·å–æ¥å£è®¿é—®å‚æ•°ã€‚

## 4.2 æŒ‰ç…§ä¸šåŠ¡åœºæ™¯åˆ’åˆ†

1. æ¡†æ¶/å®¹å™¨æ—¥å¿—
   1. Nginx
   2.  Nacos
   3. Tomcatæ—¥å¿—

2. å¾®æœåŠ¡ä¸šåŠ¡ç³»ç»Ÿï¼š
   1. æ“ä½œæ—¥å¿—ï¼šåŒ…å«çš„å­—æ®µå¦‚ä¸‹â€”â€”ï¼ˆtraceIdã€hostã€userã€timeã€messageã€levelã€paramsã€responseã€codeã€menunameã€apinameã€urlã€exectimeã€systemcodeï¼‰
   2. ç³»ç»Ÿæ—¥å¿—ï¼šç³»ç»Ÿè¿è¡Œæ—¥å¿—
   3. ç°æœ‰ä¸šåŠ¡ç³»ç»Ÿæ—¥å¿—ï¼šsdkåŒ…å¼•å…¥+ è¾“å‡ºè§„èŒƒ
   4. åå°ï¼šcuã€eu













# 5 æ—¥å¿—è¾“å‡ºè§„èŒƒ

## 5.1 ESæ—¥å¿—æ•°æ®è§„èŒƒ

| å­—æ®µ    | ç±»å‹      | é•¿åº¦ | æ˜¯å¦ä¸ºnull | æè¿°     |
| ------- | --------- | ---- | ---------- | -------- |
| time    | timestamp | 11   | not null   | ç”Ÿæˆæ—¶é—´ |
| source  | keyword   | 255  | not null   | æ—¥å¿—æ¥æº |
| message | keyword   |      | not null   | æ—¥å¿—ä¿¡æ¯ |
|         |           |      |            |          |
|         |           |      |            |          |
|         |           |      |            |          |
|         |           |      |            |          |
|         |           |      |            |          |
|         |           |      |            |          |





## 5.2 æ“ä½œæ—¥å¿—æ•°æ®ç»“æ„è§„èŒƒ



![image-20210203155452354](https://gitee.com/JungwooJava/cloudimg/raw/master/image-20210203155452354.png)

CREATE TABLE `t_operate_log` (
  `op_id` int(10) NOT NULL AUTO_INCREMENT,
  `op_operater` varchar(32) NOT NULL COMMENT 'æ“ä½œäºº',
  `op_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ“ä½œæ—¶é—´',
  `op_type` char(2) NOT NULL COMMENT 'æ“ä½œç±»å‹',
  `op_desc` text NOT NULL COMMENT 'æ“ä½œæè¿°',
  `op_result` bit(1) NOT NULL COMMENT 'æ“ä½œç»“æœ0å¤±è´¥1æˆåŠŸ',
  `op_ip` varchar(39) NOT NULL COMMENT 'æ“ä½œIP',
  `op_object` varchar(200) NOT NULL COMMENT 'æ“ä½œå¯¹è±¡',
  `op_params` text NOT NULL COMMENT 'æ“ä½œå‚æ•°',
  `op_response` text COMMENT 'è¿”å›ç»“æœ',
  `op_exec_time_millis` int(10) NOT NULL COMMENT 'æ‰§è¡Œæ—¶é—´',
  PRIMARY KEY (`op_id`) USING BTREE
) ENGINE=MyISAM AUTO_INCREMENT=139228 DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC COMMENT='ç³»ç»Ÿæ“ä½œæ—¥å¿—è¡¨ ';



# 6 æœ€ç»ˆæˆæœ

1. é‚®ä»¶å‘Šè­¦

   error çº§åˆ«æ—¥å¿—é‚®ä»¶æé†’

2. æ—¥å¿—æŸ¥è¯¢

   æ“ä½œæ—¥å¿—æŸ¥è¯¢ã€ç³»ç»Ÿæ—¥å¿—æŸ¥è¯¢

3. ç»Ÿè®¡åˆ†æ

   æ“ä½œæ—¥å¿—ç»Ÿè®¡ï¼Œæ¯”å¦‚ç™»å½•ç”¨æˆ·æ•°ã€èœå•åŠŸèƒ½çƒ­åº¦ç»Ÿè®¡

# 7 ç³»ç»Ÿå‡ºé”™å¤„ç†è®¾è®¡

## 7.1 è¡¥æ•‘æªæ–½

æ•…éšœå‡ºç°åå¯èƒ½é‡‡å–çš„å˜é€šæªæ–½ï¼ŒåŒ…æ‹¬ï¼š

l     åå¤‡æŠ€æœ¯å³æ—¥å¿—ä»ä¿ç•™å‘æ–‡ä»¶ä¼ è¾“ä¸€ä»½ï¼Œè®¾ç½®æ¸…ç†æ—¶é•¿ï¼Œå¦ä¸€ä»½å³é‡‡é›†åˆ°æ—¥å¿—ä¸­å¿ƒï¼›

l     æœåŠ¡é«˜å¯ç”¨å³æ—¥å¿—ä¸­å¿ƒé‡‡ç”¨é›†ç¾¤çš„éƒ¨ç½²æ–¹å¼ï¼ŒåŒæœºçƒ­å¤‡ï¼Œå½“æ•…éšœå‡ºç°æ—¶å®ç°è‡ªåŠ¨è½¬ç§»ã€‚



# 8 é—®é¢˜é—ç•™

```æ±‰è¯­
1ã€elasticsearchå†…å­˜å ç”¨é«˜ï¼Œä»¥åŠç´¢å¼•çš„ç®¡ç†ä¸ç»´æŠ¤ï¼Œè¿˜åœ¨ä¼˜åŒ–å’Œè€ƒè™‘ä¸­ã€‚
2ã€éœ€è¦å¼€å‘æ›´åŠ äººæ€§åŒ–ä¸”æ›´æ˜“æ‰©å±•å’Œç»´æŠ¤çš„è¿æ§å¹³å°ä¾›ä½¿ç”¨æ–¹æŸ¥è¯¢æ—¥å¿—ã€‚
3ã€æ—¥å¿—å¦‚æœéœ€è¦ä¿ç•™è¾ƒé•¿çš„æ—¶é—´ï¼Œéœ€è¦å¢åŠ å¤§æ•°æ®ç»„ä»¶ï¼Œå°†æ•°æ®å­˜å‚¨è‡³HDFSï¼Œå°†å­˜å‚¨å±‚çš„HDFSç§»åˆ°æ—¥å¿—ä¸­å¿ƒï¼Œéœ€è¦æ”¯æŒæ—¥å¿—åŒæ—¶å†™å…¥ESé›†ç¾¤å’ŒHDFSé›†ç¾¤ã€‚
4ã€æ—¥å¿—æ•°æ®æŒ–æ˜çš„åº”ç”¨ã€‚
```

